<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - SimpleConnect</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --admin-bg: #111827; --admin-sidebar: #1f2937; --admin-accent: #3b82f6; }
        body { background-color: #f3f4f6; color: #1f2937; }
        .sidebar-item.active { background-color: rgba(59, 130, 246, 0.1); color: #2563eb; border-right: 3px solid #2563eb; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-gray-900 flex items-center">
                <i data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></i>
                Admin Panel
            </h1>
            <p class="text-xs text-gray-500 mt-1">Developer Access Only</p>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button id="navLogs" onclick="switchTab('logs')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors active">
                <i data-lucide="scroll-text" class="w-5 h-5 mr-3"></i> Logs
            </button>
            <button id="navMembers" onclick="switchTab('members')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i> Members
            </button>
            <button id="navSettings" onclick="switchTab('settings')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <a href="index.html" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg hover:bg-gray-800 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Chat
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-8 shadow-sm">
            <h2 id="pageTitle" class="text-lg font-bold text-gray-800">System Logs</h2>
            <div id="currentUserDisplay" class="text-sm font-medium text-gray-500">Loading...</div>
        </header>

        <main class="flex-1 overflow-auto p-8">
            
            <!-- LOGS TAB -->
            <div id="tab-logs" class="space-y-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Recent Actions</h3>
                        <span class="text-xs text-gray-400">Live Updates</span>
                    </div>
                    <div class="divide-y divide-gray-100" id="logsContainer">
                        <div class="p-8 text-center text-gray-400 text-sm">Loading logs...</div>
                    </div>
                </div>
            </div>

            <!-- MEMBERS TAB -->
            <div id="tab-members" class="hidden space-y-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full">
                    <div class="p-4 border-b border-gray-100 flex gap-4 bg-gray-50/50">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                            <input type="text" id="memberSearch" placeholder="Search by username..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <select id="memberFilter" class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm bg-white">
                            <option value="all">All Users</option>
                            <option value="recent">Recently Active</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="developer">Developers</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 font-bold">User</th>
                                    <th class="px-6 py-3 font-bold">Role</th>
                                    <th class="px-6 py-3 font-bold">Joined</th>
                                    <th class="px-6 py-3 font-bold">Last Seen</th>
                                    <th class="px-6 py-3 font-bold text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                    <div id="membersPagination" class="p-4 border-t border-gray-100 text-center text-xs text-gray-400">
                        Showing top results
                    </div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="tab-settings" class="hidden max-w-2xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50">
                        <h3 class="text-lg font-bold text-gray-900">Global Settings</h3>
                        <p class="text-sm text-gray-500">Changes here affect everyone immediately.</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Website Title</label>
                            <input type="text" id="settingTitle" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm" placeholder="SimpleConnect Chat">
                            <p class="text-xs text-gray-400 mt-1">Appears in the browser tab.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Favicon URL</label>
                            <div class="flex gap-2">
                                <input type="text" id="settingIcon" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm" placeholder="https://example.com/icon.png">
                                <div class="w-10 h-10 rounded bg-gray-100 border flex items-center justify-center shrink-0">
                                    <img id="iconPreview" src="" class="w-6 h-6 object-contain opacity-50">
                                </div>
                            </div>
                        </div>
                        <div class="pt-4 border-t flex justify-end">
                            <button onclick="saveGlobalSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-sm transition-colors">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit, doc, updateDoc, setDoc, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Same Config
        const firebaseConfig = {
            apiKey: "AIzaSyDYI4Avd42wjJa3YOSKuGHhSCGgLFLZvik",
            authDomain: "presently-3babd.firebaseapp.com",
            projectId: "presently-3babd",
            storageBucket: "presently-3babd.firebasestorage.app",
            messagingSenderId: "646349632966",
            appId: "1:646349632966:web:70780e1952d3144842aec7",
            measurementId: "G-S78VX3DRBV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let allMembers = [];

        // Auth Check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = { id: user.uid, ...snap.data() };
                    if (currentUser.role !== 'developer') {
                        alert("Access Denied: Developers only.");
                        window.location.href = 'index.html';
                        return;
                    }
                    document.getElementById('currentUserDisplay').innerText = `Logged in as ${currentUser.username}`;
                    initAdmin();
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function initAdmin() {
            // Logs Listener
            const logsQ = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(logsQ, (snapshot) => {
                const container = document.getElementById('logsContainer');
                if (snapshot.empty) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">No logs found.</div>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(d => {
                    const data = d.data();
                    const time = data.timestamp ? new Date(data.timestamp.toMillis()).toLocaleString() : 'Just now';
                    let icon = 'info';
                    let color = 'text-gray-500 bg-gray-100';
                    
                    if(data.type === 'message_delete' || data.type === 'message_delete_all') { icon = 'trash-2'; color = 'text-red-600 bg-red-100'; }
                    if(data.type === 'message_edit') { icon = 'pencil'; color = 'text-orange-600 bg-orange-100'; }
                    if(data.type === 'rank_change') { icon = 'shield'; color = 'text-blue-600 bg-blue-100'; }
                    if(data.type === 'profile_update') { icon = 'user'; color = 'text-green-600 bg-green-100'; }

                    return `
                        <div class="p-4 flex items-start space-x-4 hover:bg-gray-50 transition-colors">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${color} shrink-0">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">
                                    <span class="font-bold">${data.username || 'Unknown'}</span>: ${data.details}
                                </p>
                                <p class="text-xs text-gray-400 mt-0.5">${time}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            });

            // Members Listener
            const membersQ = query(collection(db, "users"), orderBy("joinedAt", "desc"), limit(100));
            onSnapshot(membersQ, (snapshot) => {
                allMembers = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderMembers();
            });

            // Settings Load
            getDoc(doc(db, "settings", "global")).then(snap => {
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('settingTitle').value = d.title || '';
                    document.getElementById('settingIcon').value = d.icon || '';
                    document.getElementById('iconPreview').src = d.icon || '';
                }
            });

            // Setup Search/Filter
            document.getElementById('memberSearch').addEventListener('input', renderMembers);
            document.getElementById('memberFilter').addEventListener('change', renderMembers);
            document.getElementById('settingIcon').addEventListener('input', (e) => {
                document.getElementById('iconPreview').src = e.target.value;
            });
        }

        function renderMembers() {
            const search = document.getElementById('memberSearch').value.toLowerCase();
            const filter = document.getElementById('memberFilter').value;
            const container = document.getElementById('membersTableBody');
            
            let list = allMembers.filter(u => 
                (u.username || '').toLowerCase().includes(search)
            );

            if (filter === 'recent') {
                list.sort((a,b) => (b.lastSeen?.toMillis() || 0) - (a.lastSeen?.toMillis() || 0));
            } else if (filter === 'male') {
                list = list.filter(u => u.gender === 'Male');
            } else if (filter === 'female') {
                list = list.filter(u => u.gender === 'Female');
            } else if (filter === 'developer') {
                list = list.filter(u => u.role === 'developer');
            }

            container.innerHTML = list.map(u => {
                const joined = u.joinedAt ? new Date(u.joinedAt.toMillis()).toLocaleDateString() : 'N/A';
                const lastSeen = u.lastSeen ? new Date(u.lastSeen.toMillis()).toLocaleString() : 'Never';
                const avatar = u.avatarImage ? `<img src="${u.avatarImage}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">${u.username.substring(0,2).toUpperCase()}</div>`;
                
                return `
                    <tr class="bg-white border-b hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 flex items-center space-x-3">
                            ${avatar}
                            <span class="font-medium text-gray-900">${u.username}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 capitalize">
                                ${u.role || 'Member'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-gray-500">${joined}</td>
                        <td class="px-6 py-4 text-gray-500">${lastSeen}</td>
                        <td class="px-6 py-4 text-right">
                             <button onclick="promptRank('${u.id}', '${u.username}')" class="text-blue-600 hover:text-blue-900 text-xs font-bold hover:underline">Change Rank</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.promptRank = async (uid, name) => {
            const newRank = prompt(`Enter new rank for ${name}:`, "vip");
            if (newRank) {
                try {
                    await updateDoc(doc(db, "users", uid), { role: newRank.toLowerCase() });
                    // Log manually since this is admin action
                    await addDoc(collection(db, "logs"), {
                        type: 'rank_change',
                        userId: currentUser.id,
                        username: currentUser.username,
                        details: `Admin changed ${name}'s rank to ${newRank}`,
                        timestamp: new Date()
                    });
                    alert("Rank updated.");
                } catch(e) { alert("Error: " + e.message); }
            }
        };

        window.saveGlobalSettings = async () => {
            const title = document.getElementById('settingTitle').value.trim();
            const icon = document.getElementById('settingIcon').value.trim();
            
            try {
                await setDoc(doc(db, "settings", "global"), { title, icon }, { merge: true });
                alert("Global settings updated.");
            } catch(e) { alert("Error: " + e.message); }
        }

        // Tab Switching
        window.switchTab = (tabId) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
            const navBtn = document.getElementById(`nav${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
            if(navBtn) navBtn.classList.add('active');

            const titles = { 'logs': 'System Logs', 'members': 'Member Management', 'settings': 'Global Configuration' };
            document.getElementById('pageTitle').innerText = titles[tabId];
        };

        if(window.lucide) window.lucide.createIcons();
    </script>
</body>
</html>
