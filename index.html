<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleConnect Chat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- HTML Sanitizer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-app: #f3f4f6;
            --bg-sidebar: #ffffff;
            --text-main: #111827;
            --msg-bubble-me: #2563eb;
            --msg-text-me: #ffffff;
            --bg-input: #f9fafb;
            --border-color: #e5e7eb;
        }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Message Actions Visibility */
        .message-group:hover .msg-actions { opacity: 1; pointer-events: auto; }
        .msg-actions { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        @media (hover: none) {
            .msg-actions { opacity: 1; pointer-events: auto; }
        }

        /* Markdown Styles within Chat Bubbles */
        .markdown-content p { margin-bottom: 0.4em; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content strong { font-weight: 700; }
        .markdown-content em { font-style: italic; }
        .markdown-content code { 
            background: rgba(0,0,0,0.1); 
            padding: 0.1em 0.3em; 
            border-radius: 3px; 
            font-family: monospace; 
            font-size: 0.9em;
        }
        .bg-me .markdown-content code { background: rgba(255,255,255,0.2); }
        .markdown-content pre {
            background: rgba(0,0,0,0.1);
            padding: 0.4em;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.4em 0;
            font-size: 0.85em;
        }
        .bg-me .markdown-content pre { background: rgba(0,0,0,0.2); }
        .markdown-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.4em; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.4em; }
        .markdown-content blockquote { border-left: 2px solid rgba(0,0,0,0.2); padding-left: 0.4em; margin-left: 0.2em; opacity: 0.8; }
        .markdown-content a { text-decoration: underline; }
        
        /* Image in chat */
        .chat-image { max-width: 100%; border-radius: 8px; margin-top: 0.5rem; margin-bottom: 0.25rem; display: block; max-height: 300px; object-fit: contain; }

        /* Dynamic Theme Classes */
        .theme-scope { background-color: var(--bg-app); color: var(--text-main); }
        .theme-bg-app { background-color: var(--bg-app); color: var(--text-main); }
        .theme-bg-sidebar { background-color: var(--bg-sidebar); border-color: var(--border-color); }
        .theme-text-main { color: var(--text-main); }
        .theme-primary { background-color: var(--primary); color: white; }
        .theme-primary:hover { background-color: var(--primary-hover); }
        .theme-text-primary { color: var(--primary); }
        .theme-border-primary { border-color: var(--primary); }
        
        .bubble-me { background-color: var(--msg-bubble-me); color: var(--msg-text-me); }
        .bubble-other { background-color: var(--bg-sidebar); color: var(--text-main); border: 1px solid var(--border-color); }
        .theme-input { background-color: var(--bg-input); color: var(--text-main); border-color: var(--border-color); }
    </style>
</head>
<body class="theme-bg-app font-sans antialiased h-screen overflow-hidden text-sm">
    <div id="app" class="h-full w-full"></div>

    <!-- Hidden File Inputs -->
    <input type="file" id="avatarUploadInput" accept="image/*" class="hidden">
    <input type="file" id="bannerUploadInput" accept="image/png, image/jpeg, image/gif, image/webp" class="hidden">
    <input type="file" id="chatImageInput" accept="image/*" class="hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc, serverTimestamp, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDYI4Avd42wjJa3YOSKuGHhSCGgLFLZvik",
            authDomain: "presently-3babd.firebaseapp.com",
            projectId: "presently-3babd",
            storageBucket: "presently-3babd.firebasestorage.app",
            messagingSenderId: "646349632966",
            appId: "1:646349632966:web:70780e1952d3144842aec7",
            measurementId: "G-S78VX3DRBV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- SOUNDS ---
        // Simple Base64 Pop Sound
        const NOTIFICATION_SOUND = "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; 

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let messages = [];
        let typingUsers = {}; 
        let onlineUsers = [];
        let editingMessageId = null; 
        let lastTypingSent = 0;
        let pendingChatImage = null; // Stores base64 of image to send
        
        // Modal States
        let showThemeModal = false;
        let previewThemeId = 0;
        let showProfileModal = false;
        let viewingProfileId = null;
        let viewingProfileData = null;
        let isEditingProfile = false; 
        let editProfileForm = { username: '', color: '', banner: '', avatarImage: null, bannerImage: null }; 

        let currentThemeId = 0;
        let themes = [];

        // --- CONSTANTS ---
        const AVATAR_COLORS = [
            'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-green-500', 
            'bg-emerald-500', 'bg-teal-500', 'bg-cyan-500', 'bg-blue-500', 
            'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 
            'bg-pink-500', 'bg-rose-500', 'bg-slate-600', 'bg-stone-500'
        ];

        const BANNER_GRADIENTS = [
            'from-blue-600 to-indigo-800',
            'from-purple-500 to-pink-500',
            'from-green-400 to-blue-500',
            'from-yellow-400 to-orange-500',
            'from-red-500 to-rose-600',
            'from-gray-700 to-gray-900',
            'from-indigo-400 to-cyan-400',
            'from-fuchsia-500 to-purple-600'
        ];

        // --- THEME GENERATOR ---
        function generateThemes() {
            const t = (id, name, prim, bgApp, bgSide, txt, bord = 'rgba(0,0,0,0.08)', bgInp = '#f9fafb') => ({
                id, name, primary: prim, primaryHover: prim, bgApp, bgSidebar: bgSide, text: txt, borderColor: bord, bgInput: bgInp
            });

            // Compact list of themes
            const list = [
                t(0, 'Standard Blue', '#2563eb', '#f3f4f6', '#ffffff', '#111827'),
                t(1, 'Dark Mode', '#3b82f6', '#0f172a', '#1e293b', '#f8fafc', '#334155', '#334155'),
                t(2, 'Midnight', '#6366f1', '#111827', '#1f2937', '#f3f4f6', '#374151', '#374151'),
                t(3, 'Forest', '#059669', '#ecfdf5', '#ffffff', '#064e3b'),
                t(4, 'Deep Forest', '#10b981', '#064e3b', '#065f46', '#ecfdf5', '#047857', '#064e3b'),
                t(5, 'Spiderman', '#dc2626', '#1e3a8a', '#172554', '#f0f9ff', '#1e40af', '#1d4ed8'),
                t(6, 'Hulk', '#65a30d', '#4c1d95', '#5b21b6', '#f7fee7', '#7c3aed', '#6d28d9'),
                t(7, 'Iron Man', '#eab308', '#7f1d1d', '#991b1b', '#fefce8', '#b91c1c', '#7f1d1d'),
                t(8, 'Barbie', '#ec4899', '#fdf2f8', '#fff1f2', '#831843'),
                t(9, 'Batman', '#fbbf24', '#000000', '#171717', '#f5f5f5', '#262626', '#262626'),
                t(10, 'Joker', '#a855f7', '#172554', '#1e3a8a', '#faf5ff', '#a855f7', '#1e40af'),
                t(11, 'Matrix', '#22c55e', '#000000', '#0a0a0a', '#4ade80', '#14532d', '#052e16'),
                t(12, 'Dracula', '#e11d48', '#0f172a', '#1e293b', '#ffe4e6', '#334155', '#334155'),
                t(13, 'Bumblebee', '#facc15', '#18181b', '#27272a', '#fefce8', '#3f3f46', '#27272a'),
                t(14, 'Superman', '#ef4444', '#1d4ed8', '#1e40af', '#ffffff', '#2563eb', '#1e3a8a'),
                t(15, 'Cyberpunk', '#f472b6', '#0f172a', '#1e293b', '#2dd4bf', '#334155', '#334155'),
                t(16, 'Vaporwave', '#d8b4fe', '#fdf4ff', '#fae8ff', '#581c87'),
                t(17, 'Sunset', '#f97316', '#fff7ed', '#fffaf0', '#7c2d12'),
                t(18, 'Ocean', '#06b6d4', '#ecfeff', '#f0f9ff', '#0e7490'),
                t(19, 'Lavender', '#8b5cf6', '#f5f3ff', '#ffffff', '#4c1d95'),
                t(20, 'Coffee', '#78350f', '#fffbeb', '#fef3c7', '#451a03'),
                t(21, 'Slate', '#64748b', '#f1f5f9', '#ffffff', '#0f172a'),
                t(22, 'Monochrome', '#525252', '#f5f5f5', '#ffffff', '#000000'),
                t(23, 'Terminal', '#4ade80', '#000000', '#111111', '#4ade80', '#333333', '#111111'),
                t(24, 'Pastel Pink', '#f9a8d4', '#fff1f2', '#ffffff', '#831843'),
                t(25, 'Pastel Blue', '#93c5fd', '#eff6ff', '#ffffff', '#1e3a8a'),
                t(26, 'Mint', '#6ee7b7', '#f0fdf4', '#ffffff', '#064e3b'),
                t(27, 'Peach', '#fdba74', '#fff7ed', '#ffffff', '#7c2d12'),
                t(28, 'Lemon', '#fde047', '#fefce8', '#ffffff', '#713f12'),
                t(29, 'Ruby', '#be123c', '#fff1f2', '#ffe4e6', '#881337'),
                t(30, 'Sapphire', '#1d4ed8', '#eff6ff', '#dbeafe', '#1e3a8a'),
                t(31, 'Emerald', '#059669', '#ecfdf5', '#d1fae5', '#064e3b'),
                t(32, 'Amethyst', '#7c3aed', '#f5f3ff', '#ede9fe', '#4c1d95'),
                t(33, 'Topaz', '#eab308', '#fefce8', '#fef9c3', '#713f12'),
                t(34, 'Rose Gold', '#fb7185', '#fff1f2', '#fff0f7', '#881337'),
                t(35, 'Space Gray', '#4b5563', '#111827', '#1f2937', '#f3f4f6', '#374151', '#374151'),
                t(36, 'Navy', '#1e3a8a', '#f1f5f9', '#ffffff', '#0f172a'),
                t(37, 'Berry', '#be185d', '#fdf2f8', '#ffffff', '#831843'),
                t(38, 'Teal', '#0d9488', '#f0fdfa', '#ffffff', '#134e4a'),
                t(39, 'Cyan', '#0891b2', '#ecfeff', '#ffffff', '#164e63'),
                t(40, 'Lime', '#65a30d', '#f7fee7', '#ffffff', '#365314'),
                t(41, 'Orange', '#ea580c', '#fff7ed', '#ffffff', '#7c2d12'),
                t(42, 'Amber', '#d97706', '#fffbeb', '#ffffff', '#78350f'),
                t(43, 'Violet', '#7c3aed', '#f5f3ff', '#ffffff', '#4c1d95'),
                t(44, 'Fuchsia', '#c026d3', '#fdf4ff', '#ffffff', '#701a75'),
                t(45, 'Crimson', '#9f1239', '#fff1f2', '#ffffff', '#881337'),
                t(46, 'Chocolate', '#3f2c22', '#fdf8f6', '#ffffff', '#281c16'),
                t(47, 'Olive', '#3f6212', '#f7fee7', '#ffffff', '#1a2e05'),
                t(48, 'Sky', '#0ea5e9', '#f0f9ff', '#ffffff', '#0c4a6e'),
                t(49, 'Neutral', '#525252', '#e5e5e5', '#f5f5f5', '#171717'),
            ];
            return list;
        }

        function applyTheme(themeId) {
            const theme = themes.find(t => t.id === Number(themeId)) || themes[0];
            const root = document.documentElement;
            
            root.style.setProperty('--primary', theme.primary);
            root.style.setProperty('--primary-hover', theme.primaryHover || theme.primary);
            root.style.setProperty('--bg-app', theme.bgApp);
            root.style.setProperty('--bg-sidebar', theme.bgSidebar);
            root.style.setProperty('--text-main', theme.text);
            root.style.setProperty('--bg-input', theme.bgInput || '#f9fafb');
            root.style.setProperty('--border-color', theme.borderColor || 'rgba(0,0,0,0.08)');
            root.style.setProperty('--msg-bubble-me', theme.primary);
            root.style.setProperty('--msg-text-me', '#ffffff');

            currentThemeId = theme.id;
            localStorage.setItem('chat_theme_id', theme.id);
        }

        // --- UTILS ---
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function playSound() {
            try {
                const audio = new Audio("https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a");
                audio.volume = 0.5;
                audio.play().catch(e => console.log("Audio play failed (interaction required)"));
            } catch(e) {}
        }

        // Compress and resize images to Base64 (Enhanced for GIF detection)
        function compressImage(file, maxWidth, quality = 0.7) {
            return new Promise((resolve, reject) => {
                // If GIF and size is reasonable, skip compression to preserve animation
                if (file.type === 'image/gif') {
                     if (file.size > 1.5 * 1024 * 1024) { // 1.5 MB limit for GIFs
                         reject(new Error("GIF too large (Max 1.5MB)"));
                         return;
                     }
                     const reader = new FileReader();
                     reader.readAsDataURL(file);
                     reader.onload = (e) => resolve(e.target.result);
                     reader.onerror = (e) => reject(e);
                     return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        const width = (scaleSize < 1) ? maxWidth : img.width;
                        const height = (scaleSize < 1) ? img.height * scaleSize : img.height;
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    }
                    img.onerror = (err) => reject(err);
                }
                reader.onerror = (err) => reject(err);
            });
        }

        // Returns role config based on stored role field
        function getRoleConfig(role) {
            if (role === 'developer') {
                return { 
                    label: 'Developer', 
                    icon: 'code-2', 
                    color: 'text-blue-600', 
                    fill: 'fill-blue-500', 
                    bg: 'bg-blue-100', 
                    border: 'border-blue-200',
                    gradient: 'from-blue-600 to-indigo-800'
                };
            }
            return { 
                label: 'VIP', 
                icon: 'crown', 
                color: 'text-yellow-600', 
                fill: 'fill-yellow-500', 
                bg: 'bg-yellow-100', 
                border: 'border-yellow-200',
                gradient: 'from-yellow-400 to-orange-500'
            };
        }

        // --- APP INITIALIZATION ---
        function init() {
            themes = generateThemes();
            
            const storedUser = localStorage.getItem('chat_user');
            if (storedUser) {
                try { currentUser = JSON.parse(storedUser); } 
                catch (e) { localStorage.removeItem('chat_user'); }
            }

            const storedTheme = localStorage.getItem('chat_theme_id');
            const initTheme = storedTheme ? parseInt(storedTheme) : 0;
            applyTheme(initTheme);
            previewThemeId = initTheme;

            render();
            
            if (currentUser) {
                setupFirestoreListeners();
                updatePresenceAndMigration();
                setInterval(updatePresenceAndMigration, 60000);
            }

            document.addEventListener('click', handleGlobalClicks);
            
            // Setup File Input Listeners
            const avatarInput = document.getElementById('avatarUploadInput');
            if(avatarInput) avatarInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        const base64 = await compressImage(e.target.files[0], 200);
                        editProfileForm.avatarImage = base64;
                        renderProfileModal();
                    } catch(err) { alert(err.message); }
                }
            });

            const bannerInput = document.getElementById('bannerUploadInput');
            if(bannerInput) bannerInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        // Max width 600px for banner
                        const base64 = await compressImage(e.target.files[0], 600);
                        editProfileForm.bannerImage = base64;
                        renderProfileModal();
                    } catch(err) { alert(err.message); }
                }
            });

            const chatImgInput = document.getElementById('chatImageInput');
            if(chatImgInput) chatImgInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        const base64 = await compressImage(e.target.files[0], 400); // 400px width for chat images
                        pendingChatImage = base64;
                        // Visual indicator in chat box
                        const btn = document.getElementById('uploadImgBtn');
                        if(btn) btn.classList.add('text-green-600', 'bg-green-100');
                    } catch(err) { alert(err.message); }
                }
            });
        }

        async function updatePresenceAndMigration() {
            if (!currentUser) return;
            try {
                const updates = { lastSeen: serverTimestamp() };

                if (!currentUser.role) {
                    if (currentUser.username.toLowerCase() === 'developer') {
                        currentUser.role = 'developer';
                        updates.role = 'developer';
                    } else {
                        currentUser.role = 'vip';
                        updates.role = 'vip';
                    }
                    localStorage.setItem('chat_user', JSON.stringify(currentUser));
                }
                
                if (!currentUser.banner) {
                     const roleConfig = getRoleConfig(currentUser.role);
                     currentUser.banner = roleConfig.gradient;
                     updates.banner = roleConfig.gradient;
                     localStorage.setItem('chat_user', JSON.stringify(currentUser));
                }
                
                await setDoc(doc(db, "users", currentUser.id), updates, { merge: true });

            } catch (e) { console.error("Presence update failed", e); }
        }

        function setupFirestoreListeners() {
            const q = query(collection(db, "messages"), orderBy("timestamp", "desc"), limit(50)); // Limit 50 to prevent heavy DOM diffing
            onSnapshot(q, (snapshot) => {
                const changes = snapshot.docChanges();
                // Play sound if new message added and not from me
                let played = false;
                changes.forEach(change => {
                     if (change.type === 'added') {
                         const d = change.doc.data();
                         if (d.senderId !== currentUser.id && !played) {
                             // Only play if timestamp is recent (within 5 seconds) to avoid playing on load
                             const now = Date.now();
                             const ts = d.timestamp ? d.timestamp.toMillis() : now;
                             if (now - ts < 5000) {
                                 playSound();
                                 played = true;
                             }
                         }
                     }
                });

                messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toMillis() : Date.now()
                })).reverse();
                renderChatMessages();
            });

            const usersQ = query(collection(db, "users"));
            onSnapshot(usersQ, (snapshot) => {
                const now = Date.now();
                const cutoff = now - (2 * 60 * 1000); 
                const active = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.lastSeen && data.lastSeen.toMillis() > cutoff) {
                        active.push({ id: doc.id, ...data });
                    }
                });
                onlineUsers = active.sort((a,b) => a.username.localeCompare(b.username));
                renderRightSidebar();
            });

            const typingQ = query(collection(db, "typing"));
            onSnapshot(typingQ, (snapshot) => {
                const now = Date.now();
                const newTyping = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId !== currentUser.id && data.timestamp && (now - data.timestamp.toMillis() < 3000)) {
                        newTyping[data.userId] = { username: data.username, timestamp: data.timestamp.toMillis() };
                    }
                });
                typingUsers = newTyping;
                updateTypingUI();
            });
            setInterval(updateTypingUI, 1000);
        }

        // --- ACTIONS ---
        async function handleGlobalClicks(e) {
            const target = e.target;
            
            if (target.closest('#closeProfileBtn') || target.closest('#profileOverlay') === target) {
                showProfileModal = false;
                renderProfileModal();
                return;
            }

            const userTrigger = target.closest('.user-profile-trigger');
            if (userTrigger) {
                e.preventDefault();
                await openProfileModal(userTrigger.dataset.userId);
                return;
            }
            
            if (target.closest('#editProfileBtn')) {
                isEditingProfile = true;
                editProfileForm = { 
                    username: viewingProfileData.username, 
                    color: viewingProfileData.color, 
                    banner: viewingProfileData.banner || getRoleConfig(viewingProfileData.role).gradient,
                    avatarImage: viewingProfileData.avatarImage || null,
                    bannerImage: viewingProfileData.bannerImage || null
                };
                renderProfileModal();
            }

            if (target.closest('#cancelEditProfileBtn')) {
                isEditingProfile = false;
                renderProfileModal();
            }
            
            // Image Upload Click (Chat)
            if (target.closest('#uploadImgBtn')) {
                document.getElementById('chatImageInput').click();
                return;
            }

            // Trigger File Uploads (Profile)
            if (target.closest('#editAvatarTrigger')) {
                document.getElementById('avatarUploadInput').click();
            }

            if (target.closest('#editBannerTrigger')) {
                document.getElementById('bannerUploadInput').click();
            }

            if (target.closest('#saveProfileBtn')) {
                await saveProfile();
            }

            const editBtn = target.closest('.btn-start-edit');
            if (editBtn) { editingMessageId = editBtn.dataset.id; renderChatMessages(); return; }

            const deleteBtn = target.closest('.btn-delete');
            if (deleteBtn && confirm('Delete this message?')) {
                await deleteDoc(doc(db, "messages", deleteBtn.dataset.id)); return;
            }

            const cancelBtn = target.closest('.btn-cancel-edit');
            if (cancelBtn) { editingMessageId = null; renderChatMessages(); return; }

            const saveBtn = target.closest('.btn-save-edit');
            if (saveBtn) {
                const id = saveBtn.dataset.id;
                const input = document.querySelector(`.edit-input[data-id="${id}"]`);
                if (input && input.value.trim()) {
                    await updateDoc(doc(db, "messages", id), { text: input.value.trim(), edited: true });
                    editingMessageId = null;
                }
                return;
            }

            if (target.closest('#themeBtn')) { showThemeModal = true; previewThemeId = currentThemeId; renderThemeModal(); }
            if (target.closest('#closeThemeBtn') || target.closest('#themeOverlay') === target) { showThemeModal = false; renderThemeModal(); }
            if (target.closest('#applyThemeBtn')) { applyTheme(previewThemeId); showThemeModal = false; renderThemeModal(); }
            const themeOption = target.closest('.theme-option');
            if (themeOption) { previewThemeId = Number(themeOption.dataset.id); renderThemeModal(); }
        }

        async function openProfileModal(userId) {
            viewingProfileId = userId;
            showProfileModal = true;
            isEditingProfile = false;
            viewingProfileData = null;
            renderProfileModal();

            try {
                const docSnap = await getDoc(doc(db, "users", userId));
                if (docSnap.exists()) {
                    viewingProfileData = docSnap.data();
                    if (!viewingProfileData.role) viewingProfileData.role = 'vip';
                    if (!viewingProfileData.banner) viewingProfileData.banner = getRoleConfig(viewingProfileData.role).gradient;
                } else {
                    viewingProfileData = { username: 'Unknown', color: 'bg-gray-500', role: 'vip', banner: BANNER_GRADIENTS[0] };
                }
            } catch (e) {
                console.error("Error fetching profile", e);
                viewingProfileData = { username: 'Error', color: 'bg-red-500', role: 'vip', banner: BANNER_GRADIENTS[0] };
            }
            renderProfileModal();
        }

        async function saveProfile() {
            const newName = document.getElementById('editUsernameInput').value.trim();
            const errorEl = document.getElementById('editProfileError');
            
            if (!newName || newName.length < 2) {
                errorEl.textContent = "Username too short.";
                errorEl.classList.remove('hidden');
                return;
            }

            if (newName.toLowerCase() !== currentUser.username.toLowerCase()) {
                const q = query(collection(db, "users"), where("usernameLower", "==", newName.toLowerCase()));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    errorEl.textContent = "Username taken.";
                    errorEl.classList.remove('hidden');
                    return;
                }
            }

            try {
                const updateData = {
                    username: newName,
                    usernameLower: newName.toLowerCase(),
                    avatarImage: editProfileForm.avatarImage,
                    bannerImage: editProfileForm.bannerImage
                };
                
                if(editProfileForm.color) updateData.color = editProfileForm.color;
                if(editProfileForm.banner) updateData.banner = editProfileForm.banner;

                await updateDoc(doc(db, "users", currentUser.id), updateData);

                currentUser = { ...currentUser, ...updateData };
                localStorage.setItem('chat_user', JSON.stringify(currentUser));
                
                viewingProfileData = { ...viewingProfileData, ...updateData };
                isEditingProfile = false;
                renderProfileModal();
                renderSidebar(); 

            } catch(e) {
                console.error(e);
                errorEl.textContent = "Failed to save.";
                errorEl.classList.remove('hidden');
            }
        }

        // --- RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            if (currentUser) {
                renderChatRoom(app);
                renderThemeModal(); 
                renderProfileModal();
            } else {
                renderLogin(app);
            }
            if(window.lucide) window.lucide.createIcons();
        }

        function renderLogin(container) {
            container.innerHTML = `
                <div class="flex h-full min-h-screen w-full flex-col items-center justify-center bg-gradient-to-br from-gray-50 to-gray-200 p-4">
                    <div class="w-full max-w-sm rounded-2xl bg-white p-6 shadow-xl">
                        <div class="mb-6 flex flex-col items-center text-center">
                            <div class="mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                <i data-lucide="message-circle" class="w-6 h-6"></i>
                            </div>
                            <h1 class="mb-1 text-2xl font-bold text-gray-900">SimpleConnect</h1>
                            <p class="text-xs text-gray-500">Live, Real-time Chat.</p>
                        </div>
                        <form id="loginForm" class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Display Name</label>
                                <input id="username" type="text" class="block w-full rounded-lg border border-gray-200 p-2.5 text-sm text-gray-900 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="e.g. Alex" autocomplete="off" autofocus>
                                <p id="loginError" class="text-xs text-red-500 hidden"></p>
                            </div>
                            <button id="loginBtn" type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50">
                                Join Chat
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const usernameInput = document.getElementById('username');
                const btn = document.getElementById('loginBtn');
                const err = document.getElementById('loginError');
                
                const username = usernameInput.value.trim();
                if (!username || username.length < 2) {
                    err.textContent = 'Name too short';
                    err.classList.remove('hidden');
                    return;
                }
                
                btn.disabled = true;
                err.classList.add('hidden');

                try {
                    const usernameLower = username.toLowerCase();
                    const q = query(collection(db, "users"), where("usernameLower", "==", usernameLower));
                    const snapshot = await getDocs(q);
                    
                    if (!snapshot.empty) {
                        err.textContent = 'Username taken.';
                        err.classList.remove('hidden');
                        btn.disabled = false;
                        return;
                    }

                    const userId = crypto.randomUUID();
                    const color = AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)];
                    const role = 'vip'; 
                    const roleConfig = getRoleConfig(role);

                    const user = {
                        id: userId,
                        username,
                        usernameLower,
                        color,
                        role,
                        banner: roleConfig.gradient,
                        joinedAt: Date.now()
                    };
                    
                    currentUser = user;
                    localStorage.setItem('chat_user', JSON.stringify(user));
                    
                    await setDoc(doc(db, "users", userId), {
                        username,
                        usernameLower,
                        color,
                        role,
                        banner: roleConfig.gradient,
                        lastSeen: serverTimestamp(),
                        joinedAt: serverTimestamp()
                    });

                    init();
                } catch (error) {
                    console.error("Login error:", error);
                    err.textContent = 'Error connecting to server.';
                    err.classList.remove('hidden');
                    btn.disabled = false;
                }
            });
        }

        function renderChatRoom(container) {
            container.innerHTML = `
                <div class="flex h-screen w-full flex-col theme-bg-app md:flex-row text-sm">
                    <!-- LEFT Sidebar (Nav) -->
                    <div id="sidebar" class="theme-bg-sidebar fixed inset-y-0 left-0 z-30 w-56 transform shadow-xl transition-transform duration-300 ease-in-out md:static md:translate-x-0 -translate-x-full border-r flex flex-col shrink-0">
                        <div class="border-b theme-border-primary p-4">
                            <h2 class="text-xl font-bold theme-text-primary">SimpleConnect</h2>
                            <p class="text-xs opacity-60">Global Room</p>
                        </div>
                        <div id="sidebarContent" class="flex-1 overflow-y-auto p-3 space-y-4"></div>
                        <div class="p-3 border-t theme-border-primary">
                            <button id="logoutBtn" class="flex w-full items-center justify-center rounded-lg border border-red-200 bg-red-50/10 px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50/20 transition-colors">
                                <i data-lucide="log-out" class="mr-2 w-3 h-3"></i> Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile Overlay -->
                    <div id="overlay" class="fixed inset-0 z-20 bg-black bg-opacity-50 md:hidden hidden"></div>

                    <!-- Main Chat (Center) -->
                    <div class="flex flex-1 flex-col overflow-hidden relative h-full">
                        <!-- Mobile Header -->
                        <div class="flex items-center justify-between border-b theme-bg-sidebar p-3 shadow-sm md:hidden shrink-0">
                            <h1 class="text-lg font-bold theme-text-primary">SimpleConnect</h1>
                            <button id="menuBtn" class="p-2 opacity-70 hover:opacity-100">
                                <i data-lucide="menu" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- Messages -->
                        <div id="messagesList" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3"></div>
                        
                        <!-- Typing -->
                        <div id="typingIndicator" class="px-4 py-1.5 min-h-[1.5rem] text-[10px] opacity-60 italic flex items-center shrink-0"></div>

                        <!-- Input -->
                        <div class="theme-bg-sidebar p-3 border-t theme-border-primary shrink-0">
                            <form id="messageForm" class="mx-auto max-w-4xl relative">
                                <input id="messageInput" type="text" 
                                    placeholder="Message... (**bold**, *italic*, \`code\`)" 
                                    class="w-full rounded-full border px-4 py-2 pr-20 theme-input focus:outline-none focus:ring-1 focus:ring-opacity-50 theme-border-primary text-sm shadow-sm" 
                                    autocomplete="off" 
                                    style="--tw-ring-color: var(--primary);">
                                
                                <div class="absolute right-1.5 top-1 flex space-x-1">
                                    <button type="button" id="uploadImgBtn" class="p-1.5 rounded-full text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition-colors" title="Upload Image">
                                        <i data-lucide="paperclip" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button type="submit" id="sendBtn" class="rounded-full theme-primary p-1.5 transition-transform hover:scale-105 disabled:opacity-50 disabled:scale-100">
                                        <i data-lucide="send" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- RIGHT Sidebar (Online Users) -->
                    <div id="rightSidebar" class="hidden lg:flex w-60 flex-col border-l theme-bg-sidebar theme-border-primary shrink-0">
                         <div class="p-4 border-b theme-border-primary">
                            <h3 class="text-xs font-bold uppercase tracking-wider opacity-70">Online Users</h3>
                         </div>
                         <div id="onlineUsersList" class="flex-1 overflow-y-auto p-2"></div>
                    </div>
                    
                    <div id="themeModalContainer"></div>
                    <div id="profileModalContainer"></div>
                </div>
            `;

            renderSidebar();
            renderRightSidebar();

            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('translate-x-0');
                overlay.classList.toggle('hidden');
            };
            if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);
            if (overlay) overlay.addEventListener('click', toggleSidebar);

            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('chat_user');
                location.reload();
            });

            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');

            messageInput.addEventListener('input', (e) => {
                if (e.target.value.trim()) {
                    const now = Date.now();
                    if (now - lastTypingSent > 2500) {
                        setDoc(doc(db, "typing", currentUser.id), {
                            userId: currentUser.id,
                            username: currentUser.username,
                            timestamp: serverTimestamp()
                        });
                        lastTypingSent = now;
                    }
                }
            });

            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (!text && !pendingChatImage) return;
                
                messageInput.value = '';
                const imgToSend = pendingChatImage;
                pendingChatImage = null;
                document.getElementById('uploadImgBtn').classList.remove('text-green-600', 'bg-green-100');

                try {
                    await addDoc(collection(db, "messages"), {
                        text: text,
                        image: imgToSend, // Send Base64 image
                        senderId: currentUser.id,
                        senderName: currentUser.username,
                        senderColor: currentUser.color,
                        timestamp: serverTimestamp(),
                        edited: false
                    });
                } catch (err) {
                    console.error("Error sending", err);
                }
            });
            
            renderChatMessages();
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            if (!container) return;
            const safeUsername = escapeHtml(currentUser.username);
            
            const avatarHtml = currentUser.avatarImage 
                ? `<img src="${currentUser.avatarImage}" class="h-8 w-8 rounded-full object-cover shadow-sm">` 
                : `<div class="flex h-8 w-8 items-center justify-center rounded-full text-white font-bold shadow-sm ${currentUser.color} text-xs">${safeUsername.substring(0, 2).toUpperCase()}</div>`;

            container.innerHTML = `
                <div>
                    <h3 class="mb-2 text-[10px] font-semibold uppercase tracking-wider opacity-50">My Profile</h3>
                    <div class="user-profile-trigger flex items-center space-x-3 rounded-lg bg-gray-100/10 p-2 border border-gray-200/20 cursor-pointer hover:bg-gray-100/20 transition-colors" data-user-id="${currentUser.id}">
                        ${avatarHtml}
                        <div>
                            <p class="font-semibold text-xs">${safeUsername}</p>
                            <div class="flex items-center text-[10px] text-green-500">
                                <span class="mr-1 h-1 w-1 rounded-full bg-green-500"></span> Online
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="mb-2 text-[10px] font-semibold uppercase tracking-wider opacity-50">Settings</h3>
                    <button id="themeBtn" class="w-full flex items-center space-x-3 rounded-lg p-2 hover:bg-gray-100/10 transition-colors text-left border border-transparent hover:border-gray-200/20">
                        <div class="flex h-6 w-6 items-center justify-center rounded-full theme-primary">
                            <i data-lucide="palette" class="w-3 h-3 text-white"></i>
                        </div>
                        <div>
                            <p class="font-medium text-xs">Themes</p>
                            <p class="text-[10px] opacity-60">Customization</p>
                        </div>
                    </button>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function renderRightSidebar() {
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<div class="p-3 text-center opacity-50 text-xs italic">Looking for users...</div>';
                return;
            }

            container.innerHTML = onlineUsers.map(u => {
                const role = getRoleConfig(u.role);
                const avatarHtml = u.avatarImage 
                    ? `<img src="${u.avatarImage}" class="h-8 w-8 rounded-full object-cover shadow-sm">`
                    : `<div class="flex h-8 w-8 items-center justify-center rounded-full text-white font-bold shadow-sm ${u.color || 'bg-gray-500'} text-xs">${escapeHtml(u.username).substring(0, 2).toUpperCase()}</div>`;

                return `
                <div class="user-profile-trigger flex items-center p-2 mb-1 hover:bg-black/5 rounded-lg transition-colors cursor-pointer group" data-user-id="${u.id}">
                   <div class="relative shrink-0">
                      ${avatarHtml}
                      <div class="absolute bottom-0 right-0 h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-white ring-1 ring-gray-100"></div>
                   </div>
                   <div class="ml-2.5 min-w-0 flex-1">
                      <div class="flex items-center justify-between">
                          <p class="text-xs font-semibold truncate ${u.id === currentUser.id ? 'theme-text-primary' : 'theme-text-main'}">
                              ${escapeHtml(u.username)} ${u.id === currentUser.id ? '(You)' : ''}
                          </p>
                      </div>
                      <div class="flex items-center mt-0.5">
                        <span class="inline-flex items-center px-1 py-0 rounded text-[9px] font-bold ${role.bg} ${role.color} ${role.border} border uppercase tracking-wide">
                            <i data-lucide="${role.icon}" class="w-2.5 h-2.5 mr-0.5 ${role.fill} ${role.color}"></i> ${role.label}
                        </span>
                      </div>
                   </div>
                </div>
            `}).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        function renderThemeModal() {
            const container = document.getElementById('themeModalContainer');
            if (!container) return;

            if (!showThemeModal) { container.innerHTML = ''; return; }

            const t = themes.find(x => x.id === previewThemeId) || themes[0];
            const previewStyle = `
                --primary: ${t.primary};
                --bg-app: ${t.bgApp};
                --bg-sidebar: ${t.bgSidebar};
                --text-main: ${t.text};
                --msg-bubble-me: ${t.primary};
                --msg-text-me: #ffffff;
                --border-color: ${t.borderColor};
            `;

            container.innerHTML = `
                <div id="themeOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 backdrop-blur-sm">
                    <div class="w-full max-w-5xl h-[85vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                            <div><h2 class="text-lg font-bold text-gray-900">Choose a Theme</h2><p class="text-xs text-gray-500">Preview before you apply</p></div>
                            <div class="flex items-center space-x-2">
                                <button id="applyThemeBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition-colors">Apply Theme</button>
                                <button id="closeThemeBtn" class="p-2 hover:bg-gray-200 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-1 overflow-hidden">
                            <div class="w-1/3 border-r bg-gray-100 hidden md:flex flex-col p-4 overflow-hidden relative">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Live Preview</h3>
                                <div class="flex-1 rounded-xl shadow-lg flex flex-col overflow-hidden border theme-scope relative" style="${previewStyle}">
                                    <div class="h-10 border-b theme-bg-sidebar flex items-center px-3 space-x-2 shrink-0">
                                        <div class="w-2.5 h-2.5 rounded-full bg-red-400"></div><div class="w-2.5 h-2.5 rounded-full bg-yellow-400"></div><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div>
                                    </div>
                                    <div class="flex-1 p-3 space-y-3 overflow-hidden theme-bg-app relative">
                                        <div class="flex items-end"><div class="w-6 h-6 rounded-full bg-indigo-500 mr-2 shrink-0"></div><div class="theme-bg-sidebar p-2 rounded-xl rounded-tl-none border shadow-sm text-xs max-w-[80%]"><p class="theme-text-main opacity-90">How does this look?</p></div></div>
                                        <div class="flex flex-row-reverse items-end"><div class="theme-primary p-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[80%] text-white"><p>Looks awesome! </p></div></div>
                                    </div>
                                    <div class="h-12 theme-bg-sidebar border-t p-2 shrink-0"><div class="h-full rounded-full border opacity-50 mx-auto w-full"></div></div>
                                </div>
                                <div class="mt-4 text-center"><span class="text-sm font-bold text-gray-700">${t.name}</span></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 bg-white">
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                    ${themes.map(th => `
                                        <button class="theme-option group relative flex flex-col rounded-lg border-2 p-1.5 transition-all hover:shadow-md ${previewThemeId === th.id ? 'border-blue-600 ring-1 ring-blue-100 bg-blue-50/50' : 'border-gray-100 hover:border-gray-300 bg-white'}" data-id="${th.id}">
                                            <div class="w-full h-16 rounded mb-2 relative overflow-hidden shadow-sm border border-black/5" style="background-color: ${th.bgApp}"><div class="absolute left-0 top-0 bottom-0 w-1/4" style="background-color: ${th.bgSidebar}"></div><div class="absolute right-2 bottom-2 w-6 h-6 rounded-full shadow-sm" style="background-color: ${th.primary}"></div></div>
                                            <span class="text-[10px] font-semibold text-gray-600 group-hover:text-gray-900 text-center">${th.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function renderProfileModal() {
            const container = document.getElementById('profileModalContainer');
            if (!container) return;

            if (!showProfileModal) { container.innerHTML = ''; return; }

            const data = viewingProfileData || { username: 'Loading...', color: 'bg-gray-200', role: 'vip' };
            const role = getRoleConfig(data.role);
            
            const banner = isEditingProfile 
                ? (editProfileForm.bannerImage ? `url(${editProfileForm.bannerImage})` : (editProfileForm.banner || getRoleConfig(viewingProfileData.role).gradient))
                : (data.bannerImage ? `url(${data.bannerImage})` : (data.banner || role.gradient));
                
            const isBannerImage = (isEditingProfile && editProfileForm.bannerImage) || (!isEditingProfile && data.bannerImage);
            const avatarImage = isEditingProfile ? editProfileForm.avatarImage : data.avatarImage;
            const color = isEditingProfile ? editProfileForm.color : data.color;
            const username = isEditingProfile ? editProfileForm.username : data.username;
            const joinDate = data.joinedAt ? formatDate(data.joinedAt) : 'Unknown';
            const lastSeen = data.lastSeen ? new Date(data.lastSeen.toMillis ? data.lastSeen.toMillis() : data.lastSeen).toLocaleString() : 'Never';
            const isMe = currentUser && currentUser.id === viewingProfileId;
            const bannerStyle = isBannerImage ? `background-image: ${banner}; background-size: cover; background-position: center;` : '';
            const bannerClass = isBannerImage ? `h-32 relative bg-gray-200` : `h-32 bg-gradient-to-r ${banner} relative`;

            container.innerHTML = `
                <div id="profileOverlay" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-60 p-4 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
                     <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-visible transform transition-all scale-100 relative">
                        <!-- Close Button -->
                        <button id="closeProfileBtn" class="absolute top-4 right-4 z-10 p-2 bg-black/20 hover:bg-black/30 rounded-full text-white transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>

                        <!-- Banner -->
                        <div id="${isEditingProfile ? 'editBannerTrigger' : ''}" class="rounded-t-3xl ${bannerClass} ${isEditingProfile ? 'cursor-pointer hover:opacity-90 group' : ''}" style="${bannerStyle}">
                             ${isEditingProfile ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity rounded-t-3xl"><i data-lucide="image" class="text-white w-8 h-8 drop-shadow-lg"></i></div>' : ''}
                             
                             <!-- Avatar -->
                             <div class="absolute left-1/2 -translate-x-1/2 -bottom-12">
                                <div id="${isEditingProfile ? 'editAvatarTrigger' : ''}" class="h-24 w-24 rounded-full border-[4px] border-white shadow-lg overflow-hidden flex items-center justify-center text-3xl font-bold text-white bg-white relative ${isEditingProfile ? 'cursor-pointer hover:opacity-90 group' : ''}">
                                    ${avatarImage 
                                        ? `<img src="${avatarImage}" class="w-full h-full object-cover">` 
                                        : `<div class="w-full h-full flex items-center justify-center ${color}">${escapeHtml(username).substring(0,2).toUpperCase()}</div>`
                                    }
                                    ${isEditingProfile ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="camera" class="text-white w-6 h-6 drop-shadow-lg"></i></div>' : ''}
                                </div>
                             </div>
                        </div>
                        
                        <div class="px-6 pb-6 pt-16 relative text-center">
                            ${isMe && !isEditingProfile ? `
                                <button id="editProfileBtn" class="absolute top-4 right-6 px-4 py-1.5 rounded-full border border-gray-300 text-xs font-bold text-gray-700 hover:bg-gray-50 transition-colors">
                                    Edit Profile
                                </button>
                            ` : ''}

                            <div>
                                ${isEditingProfile ? `
                                    <div class="mb-4 text-left bg-gray-50 p-3 rounded-lg border border-gray-200">
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Current Display Name</label>
                                        <input id="editUsernameInput" type="text" value="${escapeHtml(editProfileForm.username)}" class="w-full bg-white border border-gray-300 rounded p-2 text-sm font-bold text-gray-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-200 outline-none transition-all" autocomplete="off" placeholder="Enter username...">
                                        <p id="editProfileError" class="text-red-500 text-xs mt-1 font-semibold hidden"></p>
                                    </div>
                                ` : `
                                    <div class="flex items-center justify-center space-x-2">
                                        <h2 class="text-2xl font-black text-gray-900 leading-tight">${escapeHtml(username)}</h2>
                                    </div>
                                `}

                                <div class="mt-2 flex justify-center">
                                     <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${role.bg} ${role.color} border ${role.border} uppercase tracking-wide">
                                        <i data-lucide="${role.icon}" class="w-3.5 h-3.5 mr-1.5 ${role.fill}"></i> ${role.label}
                                    </span>
                                </div>
                                
                                ${isEditingProfile ? `
                                    <div class="mt-8 flex space-x-2">
                                        <button id="saveProfileBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-bold shadow-sm">Save Changes</button>
                                        <button id="cancelEditProfileBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-bold">Cancel</button>
                                    </div>
                                ` : `
                                    <div class="mt-8 grid grid-cols-2 gap-4 border-t pt-6">
                                        <div class="flex flex-col">
                                            <span class="text-[10px] uppercase tracking-wider text-gray-400 font-bold">Joined</span>
                                            <span class="text-sm font-semibold text-gray-700">${joinDate}</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-[10px] uppercase tracking-wider text-gray-400 font-bold">Last Seen</span>
                                            <span class="text-sm font-semibold text-gray-700">${lastSeen}</span>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                     </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function getMessageHTML(msg, isMe, safeName) {
            let cleanHtml = '';
            if (window.marked && window.DOMPurify) { 
                try { cleanHtml = window.DOMPurify.sanitize(window.marked.parse(msg.text || '')); } 
                catch (e) { cleanHtml = escapeHtml(msg.text || ''); } 
            } else { cleanHtml = escapeHtml(msg.text || ''); }
            
            // Image handling
            let imageHtml = '';
            if (msg.image) {
                imageHtml = `<img src="${msg.image}" class="chat-image" alt="attachment" onclick="window.open(this.src, '_blank')">`;
            }

            // Avatar check
            let avatarSrc = null;
            if(msg.senderId === currentUser.id) avatarSrc = currentUser.avatarImage;
            else {
                const online = onlineUsers.find(u => u.id === msg.senderId);
                if(online) avatarSrc = online.avatarImage;
            }
            
            const avatarHtml = avatarSrc 
                ? `<img src="${avatarSrc}" class="h-7 w-7 rounded-full object-cover shadow-sm ${isMe ? 'ml-2' : 'mr-2'} mb-1 cursor-pointer transition-transform hover:scale-110 user-profile-trigger" data-user-id="${msg.senderId}">`
                : `<div class="user-profile-trigger flex h-7 w-7 shrink-0 items-center justify-center rounded-full text-[10px] font-bold text-white shadow-sm ${msg.senderColor || 'bg-gray-500'} ${isMe ? 'ml-2' : 'mr-2'} mb-1 cursor-pointer transition-transform hover:scale-110" data-user-id="${msg.senderId}">${safeName.substring(0, 2).toUpperCase()}</div>`;
            
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';

            return `
                <div class="flex max-w-[90%] md:max-w-[75%] ${isMe ? 'flex-row-reverse' : 'flex-row'} relative items-end">
                    ${avatarHtml}
                    ${isMe ? `<div class="msg-actions absolute top-1/2 -translate-y-1/2 flex space-x-1 z-10 ${isMe ? '-left-16 pr-1' : '-right-16 pl-1'}"><button class="btn-start-edit p-1 text-gray-500 hover:text-blue-600 rounded-full bg-white shadow-sm border border-gray-200 hover:border-blue-300 transition-all hover:scale-110" data-id="${msg.id}"><i data-lucide="pencil" class="w-3 h-3"></i></button><button class="btn-delete p-1 text-gray-500 hover:text-red-600 rounded-full bg-white shadow-sm border border-gray-200 hover:border-red-300 transition-all hover:scale-110" data-id="${msg.id}"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>` : ''}
                    <div class="relative rounded-xl px-3 py-2 shadow-sm ${isMe ? 'rounded-tr-none bubble-me bg-me' : 'rounded-tl-none bubble-other'} min-w-[50px]">
                        ${!isMe ? `<p class="user-profile-trigger mb-0.5 text-[9px] font-bold opacity-60 uppercase tracking-wide cursor-pointer hover:underline" data-user-id="${msg.senderId}">${safeName}</p>` : ''}
                        ${imageHtml}
                        <div class="markdown-content text-xs md:text-sm leading-relaxed break-words">${cleanHtml}</div>
                        <div class="flex items-center justify-end mt-0.5 space-x-1 opacity-60 border-t ${isMe ? 'border-white/20' : 'border-black/5'} pt-0.5">
                            ${msg.edited ? '<span class="text-[8px] italic">(edited)</span>' : ''}
                            <span class="text-[9px]">${time}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Smart Diffing Render
        function renderChatMessages() {
            const list = document.getElementById('messagesList');
            if (!list) return;
            
            if (messages.length === 0) {
                list.innerHTML = `<div class="flex h-full flex-col items-center justify-center text-center opacity-40"><div class="mb-4 rounded-full bg-gray-200 p-4"><i data-lucide="message-square-dashed" class="w-8 h-8"></i></div><h3 class="text-base font-medium">No messages</h3><p class="text-xs">Say hello!</p></div>`;
                return;
            }

            // Remove placeholder if present
            if(list.querySelector('.text-center.opacity-40')) list.innerHTML = '';

            const currentIds = new Set(messages.map(m => m.id));

            // 1. Remove deleted messages
            Array.from(list.children).forEach(child => {
                 const id = child.id.replace('msg-', '');
                 if (id && !currentIds.has(id)) {
                     child.remove();
                 }
            });

            // 2. Add or Update messages
            messages.forEach(msg => {
                const elId = `msg-${msg.id}`;
                let el = document.getElementById(elId);
                const isMe = msg.senderId === currentUser.id;
                const safeName = escapeHtml(msg.senderName);
                
                // If editing this specific message, show edit UI (simple re-render for this case)
                if (editingMessageId === msg.id) {
                     if (!el) {
                         el = document.createElement('div');
                         el.id = elId;
                         list.appendChild(el);
                     }
                     el.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-3`;
                     el.innerHTML = `<div class="flex max-w-[95%] md:max-w-[80%] ${isMe ? 'flex-row-reverse' : 'flex-row'} items-start"><div class="flex-1 min-w-0 bg-white rounded-lg border border-blue-200 p-2 shadow-lg z-10"><textarea class="edit-input w-full p-2 mb-1 text-xs border border-gray-200 rounded focus:border-blue-500 focus:outline-none text-gray-800 bg-gray-50 resize-none" rows="2" data-id="${msg.id}" autofocus>${escapeHtml(msg.text)}</textarea><div class="flex justify-end space-x-1"><button class="btn-cancel-edit text-[10px] px-2 py-1 text-gray-500 hover:bg-gray-100 rounded">Cancel</button><button class="btn-save-edit text-[10px] px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" data-id="${msg.id}">Save</button></div></div></div>`;
                     return;
                }

                // Normal Message View
                const contentHtml = getMessageHTML(msg, isMe, safeName);
                
                if (!el) {
                    // Create New
                    el = document.createElement('div');
                    el.id = elId;
                    el.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} group message-group`;
                    el.innerHTML = contentHtml;
                    el.dataset.ts = msg.timestamp;
                    el.dataset.edited = msg.edited;
                    list.appendChild(el);
                    
                    // Auto-scroll on new message
                    setTimeout(() => list.scrollTop = list.scrollHeight, 50);
                } else {
                    // Update if changed
                    if (el.dataset.ts != msg.timestamp || el.dataset.edited != msg.edited) {
                        el.innerHTML = contentHtml;
                        el.dataset.ts = msg.timestamp;
                        el.dataset.edited = msg.edited;
                    }
                }
            });
            
            if(window.lucide) window.lucide.createIcons();
        }

        function updateTypingUI() {
            const indicator = document.getElementById('typingIndicator');
            if (!indicator) return;
            const now = Date.now();
            const active = Object.values(typingUsers).filter(u => now - u.timestamp < 3000).map(u => escapeHtml(u.username));
            if (active.length > 0) {
                const text = active.length === 1 ? `${active[0]} is typing` : active.length === 2 ? `${active[0]} & ${active[1]} are typing` : `${active.length} people typing`;
                indicator.innerHTML = `<span class="mr-1">${text}</span><span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span><span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span><span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span>`;
            } else { indicator.innerHTML = ''; }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
