<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleConnect Chat</title>
    <link id="appFavicon" rel="icon" href="https://unpkg.com/lucide-static@latest/icons/message-circle.svg">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- HTML Sanitizer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-app: #f3f4f6;
            --bg-sidebar: #ffffff;
            --text-main: #111827;
            --msg-bubble-me: #2563eb;
            --msg-text-me: #ffffff;
            --bg-input: #f9fafb;
            --border-color: #e5e7eb;
        }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Message Actions Visibility */
        .message-group:hover .msg-actions { opacity: 1; pointer-events: auto; }
        .msg-actions { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        @media (hover: none) {
            .msg-actions { opacity: 1; pointer-events: auto; }
        }

        /* Markdown Styles within Chat Bubbles */
        .markdown-content p { margin-bottom: 0.4em; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content strong { font-weight: 700; }
        .markdown-content em { font-style: italic; }
        .markdown-content code { 
            background: rgba(0,0,0,0.1); 
            padding: 0.1em 0.3em; 
            border-radius: 3px; 
            font-family: monospace; 
            font-size: 0.9em;
        }
        .bg-me .markdown-content code { background: rgba(255,255,255,0.2); }
        .markdown-content pre {
            background: rgba(0,0,0,0.1);
            padding: 0.4em;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.4em 0;
            font-size: 0.85em;
        }
        .bg-me .markdown-content pre { background: rgba(0,0,0,0.2); }
        .markdown-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.4em; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.4em; }
        .markdown-content blockquote { border-left: 2px solid rgba(0,0,0,0.2); padding-left: 0.4em; margin-left: 0.2em; opacity: 0.8; }
        .markdown-content a { text-decoration: underline; }
        
        /* Image in chat */
        .chat-image { max-width: 100%; border-radius: 8px; margin-top: 0.5rem; margin-bottom: 0.25rem; display: block; max-height: 300px; object-fit: contain; }

        /* Mention Styles */
        .mention { background-color: rgba(255, 255, 255, 0.2); padding: 0 4px; border-radius: 4px; font-weight: bold; }
        .mention-me { background-color: #fef08a; color: #854d0e; padding: 0 4px; border-radius: 4px; font-weight: bold; border: 1px solid #fde047; }
        .bubble-me .mention { background-color: rgba(0,0,0,0.1); }

        /* Music Equalizer Animation */
        .eq-bar { animation: eq 0.5s infinite ease-in-out alternate; }
        .eq-bar:nth-child(2) { animation-delay: 0.1s; }
        .eq-bar:nth-child(3) { animation-delay: 0.2s; }
        @keyframes eq { 0% { height: 30%; } 100% { height: 100%; } }

        /* Reactions */
        .reaction-pill { 
            display: inline-flex; items-center: center; 
            padding: 2px 6px; border-radius: 12px; 
            font-size: 10px; margin-right: 4px; margin-top: 4px;
            background-color: rgba(255,255,255,0.5); 
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer; transition: all 0.2s;
        }
        .reaction-pill:hover { background-color: rgba(255,255,255,0.8); transform: scale(1.05); }
        .reaction-pill.active { background-color: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); }
        .bubble-me .reaction-pill { background-color: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.1); color: white; }
        .bubble-me .reaction-pill.active { background-color: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }

        /* Dynamic Theme Classes */
        .theme-scope { background-color: var(--bg-app); color: var(--text-main); }
        .theme-bg-app { background-color: var(--bg-app); color: var(--text-main); }
        .theme-bg-sidebar { background-color: var(--bg-sidebar); border-color: var(--border-color); }
        .theme-text-main { color: var(--text-main); }
        .theme-primary { background-color: var(--primary); color: white; }
        .theme-primary:hover { background-color: var(--primary-hover); }
        .theme-text-primary { color: var(--primary); }
        .theme-border-primary { border-color: var(--primary); }
        
        .bubble-me { background-color: var(--msg-bubble-me); color: var(--msg-text-me); }
        .bubble-other { background-color: var(--bg-sidebar); color: var(--text-main); border: 1px solid var(--border-color); }
        .theme-input { background-color: var(--bg-input); color: var(--text-main); border-color: var(--border-color); }

        /* Toast Notifications */
        @keyframes toast-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        .toast-item { animation: toast-in 0.3s ease-out forwards; }
        .toast-item.hiding { animation: toast-out 0.3s ease-in forwards; }
        
        /* Notification Dot */
        .notif-dot { position: absolute; top: 0; right: 0; transform: translate(25%, -25%); width: 0.75rem; height: 0.75rem; background-color: #ef4444; border-radius: 9999px; border: 2px solid white; }
    </style>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="theme-bg-app font-sans antialiased h-screen overflow-hidden text-sm">
    <div id="app" class="h-full w-full"></div>
    <div id="toastContainer" class="fixed top-4 left-4 z-[70] flex flex-col space-y-2 pointer-events-none"></div>

    <!-- Hidden File Inputs -->
    <input type="file" id="avatarUploadInput" accept="image/*" class="hidden">
    <input type="file" id="bannerUploadInput" accept="image/png, image/jpeg, image/gif, image/webp" class="hidden">
    <input type="file" id="chatImageInput" accept="image/*" class="hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc, serverTimestamp, setDoc, getDoc, where, getDocs, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDYI4Avd42wjJa3YOSKuGHhSCGgLFLZvik",
            authDomain: "presently-3babd.firebaseapp.com",
            projectId: "presently-3babd",
            storageBucket: "presently-3babd.firebasestorage.app",
            messagingSenderId: "646349632966",
            appId: "1:646349632966:web:70780e1952d3144842aec7",
            measurementId: "G-S78VX3DRBV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SOUNDS ---
        const NOTIFICATION_SOUND = "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; 

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let messages = [];
        let typingUsers = {}; 
        let onlineUsers = [];
        let notifications = [];
        let editingMessageId = null; 
        let lastTypingSent = 0;
        let pendingChatImage = null;
        let showNotifications = false;
        
        // Mentions State
        let mentionQuery = null;
        let mentionIndex = -1;
        
        // Tracking to prevent spam notifications locally
        let sessionViewedProfiles = new Set();
        
        // Music State (YouTube)
        let player = null;
        let isPlayerReady = false;
        let isMusicPlaying = false;
        
        // Modal States
        let showThemeModal = false;
        let previewThemeId = 0;
        let showProfileModal = false;
        let viewingProfileId = null;
        let viewingProfileData = null;
        let isEditingProfile = false; 
        let editProfileForm = { 
            username: '', color: '', banner: '', 
            avatarImage: null, bannerImage: null, 
            status: '', youtubeId: '',
            age: '', gender: ''
        }; 

        let currentThemeId = 0;
        let themes = [];

        // --- CONSTANTS ---
        const REACTIONS_LIST = ['â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ‘', 'ðŸ”¥'];
        const AVATAR_COLORS = [
            'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-green-500', 
            'bg-emerald-500', 'bg-teal-500', 'bg-cyan-500', 'bg-blue-500', 
            'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 
            'bg-pink-500', 'bg-rose-500', 'bg-slate-600', 'bg-stone-500'
        ];

        const BANNER_GRADIENTS = [
            'from-blue-600 to-indigo-800',
            'from-purple-500 to-pink-500',
            'from-green-400 to-blue-500',
            'from-yellow-400 to-orange-500',
            'from-red-500 to-rose-600',
            'from-gray-700 to-gray-900',
            'from-indigo-400 to-cyan-400',
            'from-fuchsia-500 to-purple-600'
        ];
        
        // --- LOGGING ---
        async function logAction(type, details) {
            try {
                if(!currentUser) return;
                await addDoc(collection(db, "logs"), {
                    type: type, // 'message_delete', 'message_edit', 'rank_change', 'reaction', 'profile_update', 'bot_init'
                    userId: currentUser.id,
                    username: currentUser.username,
                    details: details,
                    timestamp: serverTimestamp()
                });
            } catch(e) { console.error("Logging failed", e); }
        }
        
        async function sendNotification(targetUserId, type, content) {
            if (!currentUser || targetUserId === currentUser.id) return; // Don't notify self
            try {
                await addDoc(collection(db, "notifications"), {
                    toUserId: targetUserId,
                    type: type, // 'view', 'like', 'reaction', 'rank'
                    content: content,
                    fromUserId: currentUser.id,
                    fromUsername: currentUser.username,
                    read: false,
                    timestamp: serverTimestamp()
                });
            } catch(e) { console.error("Failed to send notification", e); }
        }

        // --- THEME GENERATOR ---
        function generateThemes() {
            const t = (id, name, prim, bgApp, bgSide, txt, bord = 'rgba(0,0,0,0.08)', bgInp = '#f9fafb') => ({
                id, name, primary: prim, primaryHover: prim, bgApp, bgSidebar: bgSide, text: txt, borderColor: bord, bgInput: bgInp
            });

            // Compact list of themes
            let list = [
                t(0, 'Standard Blue', '#2563eb', '#f3f4f6', '#ffffff', '#111827'),
                t(1, 'Dark Mode', '#3b82f6', '#0f172a', '#1e293b', '#f8fafc', '#334155', '#334155'),
                t(2, 'Midnight', '#6366f1', '#111827', '#1f2937', '#f3f4f6', '#374151', '#374151'),
                t(3, 'Forest', '#059669', '#ecfdf5', '#ffffff', '#064e3b'),
                t(4, 'Deep Forest', '#10b981', '#064e3b', '#065f46', '#ecfdf5', '#047857', '#064e3b'),
                t(5, 'Spiderman', '#dc2626', '#1e3a8a', '#172554', '#f0f9ff', '#1e40af', '#1d4ed8'),
                t(6, 'Hulk', '#65a30d', '#4c1d95', '#5b21b6', '#f7fee7', '#7c3aed', '#6d28d9'),
                t(7, 'Iron Man', '#eab308', '#7f1d1d', '#991b1b', '#fefce8', '#b91c1c', '#7f1d1d'),
                t(8, 'Barbie', '#ec4899', '#fdf2f8', '#fff1f2', '#831843'),
                t(9, 'Batman', '#fbbf24', '#000000', '#171717', '#f5f5f5', '#262626', '#262626'),
                t(10, 'Joker', '#a855f7', '#172554', '#1e3a8a', '#faf5ff', '#a855f7', '#1e40af'),
                t(11, 'Matrix', '#22c55e', '#000000', '#0a0a0a', '#4ade80', '#14532d', '#052e16'),
                t(12, 'Dracula', '#e11d48', '#0f172a', '#1e293b', '#ffe4e6', '#334155', '#334155'),
                t(13, 'Bumblebee', '#facc15', '#18181b', '#27272a', '#fefce8', '#3f3f46', '#27272a'),
                t(14, 'Superman', '#ef4444', '#1d4ed8', '#1e40af', '#ffffff', '#2563eb', '#1e3a8a'),
                t(15, 'Cyberpunk', '#f472b6', '#0f172a', '#1e293b', '#2dd4bf', '#334155', '#334155'),
                t(16, 'Rose Gold', '#e11d48', '#fff1f2', '#ffe4e6', '#881337'),
                t(17, 'Ocean Breeze', '#06b6d4', '#ecfeff', '#cffafe', '#155e75'),
                t(18, 'Sunset', '#f97316', '#fff7ed', '#ffedd5', '#9a3412'),
                t(19, 'Lavender', '#8b5cf6', '#f5f3ff', '#ede9fe', '#5b21b6'),
                t(20, 'Slate Dark', '#94a3b8', '#1e293b', '#334155', '#e2e8f0'),
                t(21, 'Mint', '#34d399', '#ecfdf5', '#d1fae5', '#065f46'),
                t(22, 'Peach', '#fb923c', '#fff7ed', '#ffedd5', '#9a3412'),
                t(23, 'Coffee', '#78350f', '#fffbeb', '#fef3c7', '#451a03'),
                t(24, 'Sky High', '#0ea5e9', '#f0f9ff', '#e0f2fe', '#075985'),
                t(25, 'Royal', '#4f46e5', '#eef2ff', '#e0e7ff', '#312e81'),
                t(26, 'Lemon', '#facc15', '#fefce8', '#fef9c3', '#854d0e'),
                t(27, 'Ruby', '#dc2626', '#fef2f2', '#fee2e2', '#991b1b'),
                t(28, 'Void', '#71717a', '#000000', '#09090b', '#d4d4d8'),
                t(29, 'Neon Green', '#39ff14', '#111111', '#222222', '#39ff14'),
                t(30, 'Hackerman', '#00ff00', '#0d0d0d', '#1a1a1a', '#00ff00'),
                t(31, 'Pastel Pink', '#f9a8d4', '#fdf2f8', '#fce7f3', '#831843'),
                t(32, 'Pastel Blue', '#93c5fd', '#eff6ff', '#dbeafe', '#1e3a8a'),
                t(33, 'Pastel Purple', '#c4b5fd', '#f5f3ff', '#ede9fe', '#4c1d95'),
                t(34, 'Monochrome', '#525252', '#ffffff', '#e5e5e5', '#171717'),
                t(35, 'Sepia', '#b45309', '#fff7ed', '#ffedd5', '#78350f'),
                t(36, 'Aqua', '#22d3ee', '#ecfeff', '#cffafe', '#164e63'),
                t(37, 'Hot Pink', '#db2777', '#fdf2f8', '#fce7f3', '#831843'),
                t(38, 'Lime', '#84cc16', '#f7fee7', '#ecfccb', '#365314'),
                t(39, 'Emerald City', '#10b981', '#022c22', '#064e3b', '#d1fae5'),
                t(40, 'Night Sky', '#6366f1', '#1e1b4b', '#312e81', '#e0e7ff'),
                t(41, 'Cherry', '#be123c', '#fff1f2', '#ffe4e6', '#881337'),
                t(42, 'Teal Dark', '#14b8a6', '#134e4a', '#115e59', '#ccfbf1'),
                t(43, 'Orange Dark', '#f97316', '#431407', '#7c2d12', '#ffedd5'),
                t(44, 'Indigo Dark', '#6366f1', '#312e81', '#3730a3', '#e0e7ff'),
                t(45, 'Violet Dark', '#8b5cf6', '#4c1d95', '#5b21b6', '#ede9fe'),
                t(46, 'Fuchsia Dark', '#d946ef', '#701a75', '#86198f', '#fae8ff'),
                t(47, 'Rose Dark', '#f43f5e', '#881337', '#9f1239', '#ffe4e6'),
                t(48, 'Slate Light', '#475569', '#f1f5f9', '#e2e8f0', '#0f172a'),
                t(49, 'Zinc Light', '#52525b', '#f4f4f5', '#e4e4e7', '#18181b'),
                t(50, 'Neutral Light', '#525252', '#f5f5f5', '#e5e5e5', '#171717'),
                t(51, 'Stone Light', '#57534e', '#fafaf9', '#e7e5e4', '#1c1917'),
                t(52, 'Red Light', '#dc2626', '#fef2f2', '#fee2e2', '#7f1d1d'),
                t(53, 'Orange Light', '#ea580c', '#fff7ed', '#ffedd5', '#7c2d12'),
                t(54, 'Amber Light', '#d97706', '#fffbeb', '#fef3c7', '#78350f'),
                t(55, 'Yellow Light', '#ca8a04', '#fefce8', '#fef9c3', '#713f12'),
                t(56, 'Lime Light', '#65a30d', '#f7fee7', '#ecfccb', '#3f6212'),
                t(57, 'Green Light', '#16a34a', '#f0fdf4', '#dcfce7', '#14532d'),
                t(58, 'Emerald Light', '#059669', '#ecfdf5', '#d1fae5', '#064e3b'),
                t(59, 'Teal Light', '#0d9488', '#f0fdfa', '#ccfbf1', '#134e4a'),
                t(60, 'Cyan Light', '#0891b2', '#ecfeff', '#cffafe', '#155e75'),
                t(61, 'Sky Light', '#0284c7', '#f0f9ff', '#e0f2fe', '#0c4a6e'),
                t(62, 'Blue Light', '#2563eb', '#eff6ff', '#dbeafe', '#1e3a8a'),
                t(63, 'Indigo Light', '#4f46e5', '#eef2ff', '#e0e7ff', '#312e81'),
                t(64, 'Violet Light', '#7c3aed', '#f5f3ff', '#ede9fe', '#5b21b6')
            ];
            return list;
        }

        function applyTheme(themeId) {
            const theme = themes.find(t => t.id === Number(themeId)) || themes[0];
            const root = document.documentElement;
            
            root.style.setProperty('--primary', theme.primary);
            root.style.setProperty('--primary-hover', theme.primaryHover || theme.primary);
            root.style.setProperty('--bg-app', theme.bgApp);
            root.style.setProperty('--bg-sidebar', theme.bgSidebar);
            root.style.setProperty('--text-main', theme.text);
            root.style.setProperty('--bg-input', theme.bgInput || '#f9fafb');
            root.style.setProperty('--border-color', theme.borderColor || 'rgba(0,0,0,0.08)');
            root.style.setProperty('--msg-bubble-me', theme.primary);
            root.style.setProperty('--msg-text-me', '#ffffff');

            currentThemeId = theme.id;
            localStorage.setItem('chat_theme_id', theme.id);
        }

        // --- UTILS ---
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function playSound() {
            try {
                const audio = new Audio("https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a");
                audio.volume = 0.5;
                audio.play().catch(e => console.log("Audio play failed (interaction required)"));
            } catch(e) {}
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if(!container) return;
            const el = document.createElement('div');
            el.className = `toast-item max-w-xs px-4 py-2 rounded-lg shadow-lg text-xs font-bold flex items-center mb-2 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'}`;
            el.innerText = message;
            container.appendChild(el);
            setTimeout(() => {
                el.classList.add('hiding');
                el.addEventListener('animationend', () => el.remove());
            }, 3000);
        }

        function compressImage(file, maxWidth, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (file.type === 'image/gif') {
                     if (file.size > 1.5 * 1024 * 1024) { 
                         reject(new Error("GIF too large (Max 1.5MB)"));
                         return;
                     }
                     const reader = new FileReader();
                     reader.readAsDataURL(file);
                     reader.onload = (e) => resolve(e.target.result);
                     reader.onerror = (e) => reject(e);
                     return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        const width = (scaleSize < 1) ? maxWidth : img.width;
                        const height = (scaleSize < 1) ? img.height * scaleSize : img.height;
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    }
                    img.onerror = (err) => reject(err);
                }
                reader.onerror = (err) => reject(err);
            });
        }

        function getRoleConfig(role) {
            const r = (role || '').toLowerCase();
            switch(r) {
                // High Staff
                case 'developer': return { label: 'Developer', icon: 'code-2', color: 'text-blue-600', fill: 'fill-blue-500', bg: 'bg-blue-100', border: 'border-blue-200', gradient: 'from-blue-600 to-cyan-500' };
                case 'founder': return { label: 'Founder', icon: 'flag', color: 'text-indigo-600', fill: 'fill-indigo-500', bg: 'bg-indigo-100', border: 'border-indigo-200', gradient: 'from-indigo-600 to-purple-600' };
                case 'head owner': return { label: 'Head Owner', icon: 'key', color: 'text-red-800', fill: 'fill-red-700', bg: 'bg-red-200', border: 'border-red-300', gradient: 'from-red-800 to-rose-900' };
                case 'owner': return { label: 'Owner', icon: 'key', color: 'text-orange-700', fill: 'fill-orange-600', bg: 'bg-orange-100', border: 'border-orange-200', gradient: 'from-orange-600 to-red-600' };
                case 'ceo': return { label: 'CEO', icon: 'briefcase', color: 'text-slate-800', fill: 'fill-slate-700', bg: 'bg-slate-200', border: 'border-slate-300', gradient: 'from-slate-800 to-gray-900' };
                case 'manager': return { label: 'Manager', icon: 'clipboard-list', color: 'text-slate-600', fill: 'fill-slate-500', bg: 'bg-slate-100', border: 'border-slate-200', gradient: 'from-slate-600 to-gray-600' };
                
                // Staff
                case 'super admin': return { label: 'Super Admin', icon: 'shield-check', color: 'text-red-600', fill: 'fill-red-500', bg: 'bg-red-100', border: 'border-red-200', gradient: 'from-red-600 to-pink-600' };
                case 'admin': return { label: 'Admin', icon: 'shield-alert', color: 'text-red-500', fill: 'fill-red-400', bg: 'bg-red-50', border: 'border-red-200', gradient: 'from-red-500 to-orange-500' };
                case 'moderator': return { label: 'Moderator', icon: 'shield', color: 'text-green-600', fill: 'fill-green-500', bg: 'bg-green-100', border: 'border-green-200', gradient: 'from-green-500 to-teal-500' };
                case 'site helper': return { label: 'Site Helper', icon: 'help-circle', color: 'text-teal-600', fill: 'fill-teal-500', bg: 'bg-teal-100', border: 'border-teal-200', gradient: 'from-teal-500 to-emerald-500' };
                
                // Fun / Special
                case 'king': return { label: 'King', icon: 'crown', color: 'text-yellow-600', fill: 'fill-yellow-500', bg: 'bg-yellow-100', border: 'border-yellow-200', gradient: 'from-yellow-400 to-amber-600' };
                case 'princess': return { label: 'Princess', icon: 'heart', color: 'text-pink-500', fill: 'fill-pink-400', bg: 'bg-pink-100', border: 'border-pink-200', gradient: 'from-pink-400 to-rose-400' };
                case 'butterfly': return { label: 'Butterfly', icon: 'feather', color: 'text-fuchsia-500', fill: 'fill-fuchsia-400', bg: 'bg-fuchsia-100', border: 'border-fuchsia-200', gradient: 'from-fuchsia-400 to-purple-400' };
                case 'legend': return { label: 'Legend', icon: 'trophy', color: 'text-amber-500', fill: 'fill-amber-400', bg: 'bg-amber-50', border: 'border-amber-200', gradient: 'from-amber-400 to-yellow-400' };
                case 'verified member': return { label: 'Verified', icon: 'check-circle', color: 'text-blue-500', fill: 'fill-blue-400', bg: 'bg-blue-50', border: 'border-blue-200', gradient: 'from-blue-400 to-cyan-400' };
                case 'premium': return { label: 'Premium', icon: 'diamond', color: 'text-purple-600', fill: 'fill-purple-500', bg: 'bg-purple-100', border: 'border-purple-200', gradient: 'from-purple-500 to-indigo-500' };
                case 'ghost': return { label: 'Ghost', icon: 'ghost', color: 'text-gray-500', fill: 'fill-gray-400', bg: 'bg-gray-100', border: 'border-gray-200', gradient: 'from-gray-400 to-slate-400' };
                case 'teddy': return { label: 'Teddy', icon: 'smile', color: 'text-orange-800', fill: 'fill-orange-400', bg: 'bg-orange-100', border: 'border-orange-200', gradient: 'from-orange-700 to-amber-700' };
                case 'special vip': return { label: 'Special VIP', icon: 'star', color: 'text-orange-500', fill: 'fill-orange-400', bg: 'bg-orange-50', border: 'border-orange-200', gradient: 'from-orange-400 to-red-400' };
                case 'vip': return { label: 'VIP', icon: 'crown', color: 'text-yellow-600', fill: 'fill-yellow-500', bg: 'bg-yellow-50', border: 'border-yellow-200', gradient: 'from-yellow-300 to-orange-300' };
                
                // Bot
                case 'bot': return { label: 'Bot', icon: 'bot', color: 'text-blue-500', fill: 'fill-blue-400', bg: 'bg-blue-50', border: 'border-blue-200', gradient: 'from-blue-500 to-cyan-500' };

                // Default
                default: return { label: 'Member', icon: 'user', color: 'text-gray-600', fill: 'fill-gray-400', bg: 'bg-gray-100', border: 'border-gray-200', gradient: 'from-gray-400 to-gray-500' };
            }
        }
        
        function getRolePriority(role) {
            const r = (role || '').toLowerCase();
            const ranks = [
                'developer', 'founder', 'head owner', 'owner', 'ceo', 'manager',
                'super admin', 'admin', 'moderator', 'site helper',
                'bot', 'king', 'princess', 'legend', 'premium', 'special vip', 'vip', 
                'verified member', 'butterfly', 'teddy', 'ghost'
            ];
            const idx = ranks.indexOf(r);
            if(idx !== -1) return 100 - idx;
            return 0;
        }

        // --- APP INITIALIZATION ---
        function init() {
            themes = generateThemes();
            
            const storedTheme = localStorage.getItem('chat_theme_id');
            const initTheme = storedTheme ? parseInt(storedTheme) : 0;
            applyTheme(initTheme);
            previewThemeId = initTheme;

            // Global Settings Listener
            onSnapshot(doc(db, "settings", "global"), (snap) => {
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.title) document.title = d.title;
                    if (d.icon) document.getElementById('appFavicon').href = d.icon;
                }
            });

            // Ensure Bot Exists
            ensureBotExists();

            // Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            currentUser = { id: user.uid, ...userDoc.data() };
                            // Fallback if role is missing
                            if (!currentUser.role) currentUser.role = 'vip';
                            
                            // Start Listeners
                            render();
                            setupFirestoreListeners();
                            updatePresenceAndMigration();
                            setInterval(updatePresenceAndMigration, 60000);
                        } else {
                            // Account created but no doc? (Edge case)
                            console.error("User authenticated but no profile found.");
                            renderLogin(document.getElementById('app'));
                        }
                    } catch (e) {
                        console.error("Auth init error:", e);
                        renderLogin(document.getElementById('app'));
                    }
                } else {
                    currentUser = null;
                    render(); // Will render Login
                }
            });

            document.addEventListener('click', handleGlobalClicks);
            
            const avatarInput = document.getElementById('avatarUploadInput');
            if(avatarInput) avatarInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        const base64 = await compressImage(e.target.files[0], 200);
                        editProfileForm.avatarImage = base64;
                        renderProfileModal();
                    } catch(err) { alert(err.message); }
                }
            });

            const bannerInput = document.getElementById('bannerUploadInput');
            if(bannerInput) bannerInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        const base64 = await compressImage(e.target.files[0], 600);
                        editProfileForm.bannerImage = base64;
                        renderProfileModal();
                    } catch(err) { alert(err.message); }
                }
            });

            const chatImgInput = document.getElementById('chatImageInput');
            if(chatImgInput) chatImgInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        const base64 = await compressImage(e.target.files[0], 400); 
                        pendingChatImage = base64;
                        const btn = document.getElementById('uploadImgBtn');
                        if(btn) btn.classList.add('text-green-600', 'bg-green-100');
                    } catch(err) { alert(err.message); }
                }
            });
        }
        
        async function ensureBotExists() {
            const botId = 'simple_bot_uid';
            try {
                const docRef = doc(db, "users", botId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    await setDoc(docRef, {
                        username: 'Simple Bot',
                        usernameLower: 'simple bot',
                        role: 'bot',
                        color: 'bg-blue-500',
                        status: 'I am a simple bot. I do nothing.',
                        avatarImage: null,
                        banner: 'from-blue-500 to-cyan-500',
                        lastSeen: serverTimestamp(),
                        joinedAt: serverTimestamp(),
                        age: '100',
                        gender: 'Bot'
                    });
                }
            } catch (e) { console.error("Bot init failed", e); }
        }

        async function updatePresenceAndMigration() {
            if (!currentUser) return;
            try {
                const updates = { lastSeen: serverTimestamp() };
                await setDoc(doc(db, "users", currentUser.id), updates, { merge: true });
            } catch (e) { console.error("Presence update failed", e); }
        }

        function setupFirestoreListeners() {
            const q = query(collection(db, "messages"), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(q, (snapshot) => {
                const changes = snapshot.docChanges();
                let played = false;
                changes.forEach(change => {
                     if (change.type === 'added') {
                         const d = change.doc.data();
                         if (d.senderId !== currentUser.id && !played) {
                             const now = Date.now();
                             const ts = d.timestamp ? d.timestamp.toMillis() : now;
                             if (now - ts < 5000) {
                                 playSound();
                                 played = true;
                             }
                         }
                     }
                });

                messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toMillis() : Date.now()
                })).reverse();
                renderChatMessages();
            });

            const usersQ = query(collection(db, "users"));
            onSnapshot(usersQ, (snapshot) => {
                const now = Date.now();
                const cutoff = now - (2 * 60 * 1000); 
                const active = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Consider online if seen recently OR if it is the Bot
                    if ((data.lastSeen && data.lastSeen.toMillis() > cutoff) || doc.id === 'simple_bot_uid') {
                        active.push({ id: doc.id, ...data });
                    }
                });
                
                // Sort by Rank Hierarchy then Alphabetical
                onlineUsers = active.sort((a,b) => {
                    const pA = getRolePriority(a.role);
                    const pB = getRolePriority(b.role);
                    if (pA !== pB) return pB - pA; // Higher priority first
                    return a.username.localeCompare(b.username);
                });
                
                renderRightSidebar();
                renderSidebar(); // Update My Status in sidebar
            });

            const typingQ = query(collection(db, "typing"));
            onSnapshot(typingQ, (snapshot) => {
                const now = Date.now();
                const newTyping = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId !== currentUser.id && data.timestamp && (now - data.timestamp.toMillis() < 3000)) {
                        newTyping[data.userId] = { username: data.username, timestamp: data.timestamp.toMillis() };
                    }
                });
                typingUsers = newTyping;
                updateTypingUI();
            });
            setInterval(updateTypingUI, 1000);
            
            // Notifications Listener
            if (currentUser) {
                const notifQ = query(collection(db, "notifications"), where("toUserId", "==", currentUser.id), orderBy("timestamp", "desc"), limit(20));
                onSnapshot(notifQ, (snapshot) => {
                    notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNotificationsPanel();
                });
            }
        }

        // --- ACTIONS ---
        async function handleGlobalClicks(e) {
            const target = e.target;
            
            // Profile Toggles
            if (target.closest('#closeProfileBtn') || target.closest('#profileOverlay') === target) {
                if (player && player.pauseVideo) player.pauseVideo();
                isMusicPlaying = false;
                showProfileModal = false;
                renderProfileModal();
                return;
            }

            const userTrigger = target.closest('.user-profile-trigger');
            if (userTrigger) {
                e.preventDefault();
                await openProfileModal(userTrigger.dataset.userId);
                return;
            }
            
            // ... Message/Profile Actions ...
            if (target.closest('#profileLikeBtn')) {
                await toggleProfileLike(viewingProfileId);
                return;
            }

            // ... Existing logic ...
            const mentionItem = target.closest('.mention-item');
            if (mentionItem) {
                const username = mentionItem.dataset.username;
                const input = document.getElementById('messageInput');
                const before = input.value.substring(0, mentionIndex);
                input.value = before + username + ' ';
                input.focus();
                mentionQuery = null;
                mentionIndex = -1;
                renderMentionDropdown();
                return;
            }

            // Reaction Click
            const reactionBtn = target.closest('.reaction-btn-trigger');
            if (reactionBtn) {
                const emoji = reactionBtn.dataset.emoji;
                const msgId = reactionBtn.dataset.id;
                await toggleReaction(msgId, emoji);
                return;
            }

            // Music Toggle (YouTube)
            if (target.closest('#toggleMusicBtn')) {
                if (player && player.getPlayerState) {
                    const state = player.getPlayerState();
                    if (state === 1) { // Playing
                        player.pauseVideo();
                        isMusicPlaying = false;
                    } else {
                        player.playVideo();
                        isMusicPlaying = true;
                    }
                    renderProfileModal(); 
                }
            }

            if (target.closest('#editProfileBtn')) {
                isEditingProfile = true;
                editProfileForm = { 
                    username: viewingProfileData.username, 
                    color: viewingProfileData.color, 
                    banner: viewingProfileData.banner || getRoleConfig(viewingProfileData.role).gradient,
                    avatarImage: viewingProfileData.avatarImage || null,
                    bannerImage: viewingProfileData.bannerImage || null,
                    youtubeId: viewingProfileData.youtubeId || '',
                    status: viewingProfileData.status || '',
                    age: viewingProfileData.age || '',
                    gender: viewingProfileData.gender || ''
                };
                renderProfileModal();
            }

            if (target.closest('#cancelEditProfileBtn')) {
                isEditingProfile = false;
                renderProfileModal();
            }
            
            if (target.closest('#uploadImgBtn')) {
                document.getElementById('chatImageInput').click();
                return;
            }

            if (target.closest('#editAvatarTrigger')) {
                document.getElementById('avatarUploadInput').click();
            }

            if (target.closest('#editBannerTrigger')) {
                document.getElementById('bannerUploadInput').click();
            }

            if (target.closest('#saveProfileBtn')) {
                await saveProfile();
            }

            // ... Edit/Delete Message ...
            const editBtn = target.closest('.btn-start-edit');
            if (editBtn) { editingMessageId = editBtn.dataset.id; renderChatMessages(); return; }

            const deleteBtn = target.closest('.btn-delete');
            if (deleteBtn && confirm('Delete this message?')) {
                const msg = messages.find(m => m.id === deleteBtn.dataset.id);
                const txt = msg ? msg.text : 'Unknown';
                await logAction('message_delete', `Deleted message: "${txt}"`);
                await deleteDoc(doc(db, "messages", deleteBtn.dataset.id)); return;
            }

            const cancelBtn = target.closest('.btn-cancel-edit');
            if (cancelBtn) { editingMessageId = null; renderChatMessages(); return; }

            const saveBtn = target.closest('.btn-save-edit');
            if (saveBtn) {
                const id = saveBtn.dataset.id;
                const input = document.querySelector(`.edit-input[data-id="${id}"]`);
                if (input && input.value.trim()) {
                    const newVal = input.value.trim();
                    await updateDoc(doc(db, "messages", id), { text: newVal, edited: true });
                    await logAction('message_edit', `Edited message to: "${newVal}"`);
                    editingMessageId = null;
                }
                return;
            }

            if (target.closest('#themeBtn')) { showThemeModal = true; previewThemeId = currentThemeId; renderThemeModal(); }
            if (target.closest('#closeThemeBtn') || target.closest('#themeOverlay') === target) { showThemeModal = false; renderThemeModal(); }
            if (target.closest('#applyThemeBtn')) { applyTheme(previewThemeId); showThemeModal = false; renderThemeModal(); }
            const themeOption = target.closest('.theme-option');
            if (themeOption) { previewThemeId = Number(themeOption.dataset.id); renderThemeModal(); }

            if (target.closest('#adminPanelBtn')) {
                window.location.href = 'admin.html';
            }
            
            if (target.closest('#notificationBtn')) {
                showNotifications = !showNotifications;
                const panel = document.getElementById('notificationPanel');
                if (showNotifications) {
                    panel.classList.remove('hidden');
                    // Mark as read
                    const unread = notifications.filter(n => !n.read);
                    if (unread.length > 0) {
                        const batch = writeBatch(db);
                        unread.forEach(n => {
                            batch.update(doc(db, "notifications", n.id), { read: true });
                        });
                        batch.commit();
                    }
                } else {
                    panel.classList.add('hidden');
                }
            } else if (showNotifications && !target.closest('#notificationPanel')) {
                showNotifications = false;
                document.getElementById('notificationPanel').classList.add('hidden');
            }
        }

        async function toggleReaction(msgId, emoji) {
            const msg = messages.find(m => m.id === msgId);
            if (!msg) return;
            
            const reactions = msg.reactions || {};
            let users = reactions[emoji] || [];
            
            if (users.includes(currentUser.id)) {
                users = users.filter(id => id !== currentUser.id);
            } else {
                users.push(currentUser.id);
                // Send Notification if reacting to someone else's message
                if (msg.senderId !== currentUser.id) {
                     await sendNotification(msg.senderId, 'reaction', `${currentUser.username} reacted ${emoji} to your message`);
                }
            }
            
            await logAction('reaction', `Toggled ${emoji} on message: "${msg.text}"`);

            const fieldPath = `reactions.${emoji}`;
            try {
                await updateDoc(doc(db, "messages", msgId), {
                    [fieldPath]: users
                });
            } catch (e) {
                // Fallback for missing field
                 const newReactions = { ...reactions, [emoji]: users };
                 await setDoc(doc(db, "messages", msgId), { reactions: newReactions }, { merge: true });
            }
        }

        async function toggleProfileLike(targetUserId) {
            if (!currentUser || !targetUserId) return;
            try {
                const userRef = doc(db, "users", targetUserId);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const likedBy = data.likedBy || [];
                    if (likedBy.includes(currentUser.id)) {
                        await updateDoc(userRef, { likedBy: arrayRemove(currentUser.id) });
                        if (viewingProfileData) viewingProfileData.likedBy = likedBy.filter(id => id !== currentUser.id);
                    } else {
                        await updateDoc(userRef, { likedBy: arrayUnion(currentUser.id) });
                        // Send Notification
                        await sendNotification(targetUserId, 'like', `${currentUser.username} liked your profile`);
                        if (viewingProfileData) viewingProfileData.likedBy = [...likedBy, currentUser.id];
                    }
                    renderProfileModal();
                }
            } catch (e) { console.error("Error toggling like", e); }
        }

        async function openProfileModal(userId) {
            viewingProfileId = userId;
            showProfileModal = true;
            isEditingProfile = false;
            viewingProfileData = null;
            renderProfileModal();
            
            // Send Notification (Debounced by session)
            if (userId !== currentUser.id && !sessionViewedProfiles.has(userId)) {
                sessionViewedProfiles.add(userId);
                await sendNotification(userId, 'view', `${currentUser.username} viewed your profile`);
            }

            try {
                const docSnap = await getDoc(doc(db, "users", userId));
                if (docSnap.exists()) {
                    viewingProfileData = docSnap.data();
                    if (!viewingProfileData.role) viewingProfileData.role = 'vip';
                    if (!viewingProfileData.banner) viewingProfileData.banner = getRoleConfig(viewingProfileData.role).gradient;
                    if (!viewingProfileData.likedBy) viewingProfileData.likedBy = [];
                    
                    if (viewingProfileData.youtubeId && window.YT) {
                        setTimeout(() => {
                            if(document.getElementById('hidden-player')) {
                                player = new YT.Player('hidden-player', {
                                    height: '1', width: '1',
                                    videoId: viewingProfileData.youtubeId,
                                    playerVars: { 'autoplay': 1, 'playsinline': 1, 'controls': 0, 'disablekb': 1 },
                                    events: {
                                        'onReady': (event) => {
                                            isPlayerReady = true;
                                            event.target.unMute();
                                            event.target.playVideo();
                                            isMusicPlaying = true;
                                            renderProfileModal();
                                        },
                                        'onStateChange': (event) => {
                                            if (event.data === YT.PlayerState.PLAYING) isMusicPlaying = true;
                                            else isMusicPlaying = false;
                                            renderProfileModal();
                                        }
                                    }
                                });
                            }
                        }, 100);
                    }
                } else {
                    viewingProfileData = { username: 'Unknown', color: 'bg-gray-500', role: 'vip', banner: BANNER_GRADIENTS[0], likedBy: [] };
                }
            } catch (e) {
                console.error("Error fetching profile", e);
                viewingProfileData = { username: 'Error', color: 'bg-red-500', role: 'vip', banner: BANNER_GRADIENTS[0], likedBy: [] };
            }
            renderProfileModal();
        }

        async function saveProfile() {
            const newName = document.getElementById('editUsernameInput').value.trim();
            const status = document.getElementById('editStatusInput').value.trim();
            const youtubeLink = document.getElementById('editYoutubeInput').value.trim();
            const age = document.getElementById('editAgeInput').value.trim();
            const gender = document.getElementById('editGenderInput').value.trim();
            const errorEl = document.getElementById('editProfileError');
            
            if (!newName || newName.length < 2) {
                errorEl.textContent = "Username too short.";
                errorEl.classList.remove('hidden');
                return;
            }

            if (newName.toLowerCase() !== currentUser.username.toLowerCase()) {
                const q = query(collection(db, "users"), where("usernameLower", "==", newName.toLowerCase()));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    errorEl.textContent = "Username taken.";
                    errorEl.classList.remove('hidden');
                    return;
                }
            }

            let yId = editProfileForm.youtubeId;
            if (youtubeLink) {
                const extracted = getYouTubeId(youtubeLink);
                if (extracted) yId = extracted;
                else if (youtubeLink.length === 11) yId = youtubeLink; 
            } else if (youtubeLink === '') {
                yId = '';
            }

            try {
                const updateData = {
                    username: newName,
                    usernameLower: newName.toLowerCase(),
                    avatarImage: editProfileForm.avatarImage,
                    bannerImage: editProfileForm.bannerImage,
                    status: status,
                    youtubeId: yId,
                    age: age,
                    gender: gender
                };
                
                if(editProfileForm.color) updateData.color = editProfileForm.color;
                if(editProfileForm.banner) updateData.banner = editProfileForm.banner;

                await updateDoc(doc(db, "users", currentUser.id), updateData);
                await logAction('profile_update', `Updated profile (name: ${newName})`);
                
                currentUser = { ...currentUser, ...updateData };
                viewingProfileData = { ...viewingProfileData, ...updateData };
                isEditingProfile = false;
                renderProfileModal();
                renderSidebar(); 

            } catch(e) {
                console.error(e);
                errorEl.textContent = "Failed to save.";
                errorEl.classList.remove('hidden');
            }
        }

        // --- RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            if (currentUser) {
                renderChatRoom(app);
                renderThemeModal(); 
                renderProfileModal();
            } else {
                renderLogin(app);
            }
            if(window.lucide) window.lucide.createIcons();
        }

        function renderLogin(container) {
            // Check if already authenticated to prevent flash
            if(auth.currentUser && currentUser) return; 

            // Defaults to 'login' view, but can switch to 'signup'
            let view = 'login'; 

            const renderForm = () => {
                container.innerHTML = `
                    <div class="flex h-full min-h-screen w-full flex-col items-center justify-center bg-gradient-to-br from-gray-50 to-gray-200 p-4">
                        <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl transition-all">
                            <div class="mb-6 flex flex-col items-center text-center">
                                <div class="mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                    <i data-lucide="message-circle" class="w-6 h-6"></i>
                                </div>
                                <h1 class="mb-1 text-2xl font-bold text-gray-900">SimpleConnect</h1>
                                <p class="text-xs text-gray-500">Live, Real-time Chat.</p>
                            </div>

                            <div class="mb-6 flex rounded-lg bg-gray-100 p-1">
                                <button id="tabLogin" class="flex-1 rounded-md py-1.5 text-sm font-medium transition-all ${view === 'login' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Sign In</button>
                                <button id="tabSignup" class="flex-1 rounded-md py-1.5 text-sm font-medium transition-all ${view === 'signup' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Sign Up</button>
                            </div>

                            <form id="authForm" class="space-y-4">
                                ${view === 'signup' ? `
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="space-y-1">
                                            <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Username</label>
                                            <input id="regUsername" type="text" class="block w-full rounded-lg border border-gray-200 p-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 bg-white" placeholder="Display Name" required>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Age</label>
                                            <input id="regAge" type="number" class="block w-full rounded-lg border border-gray-200 p-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 bg-white" placeholder="e.g. 24">
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Gender</label>
                                        <select id="regGender" class="block w-full rounded-lg border border-gray-200 p-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 bg-white">
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Non-binary">Non-binary</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                ` : ''}

                                <div class="space-y-1">
                                    <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Email</label>
                                    <input id="authEmail" type="email" class="block w-full rounded-lg border border-gray-200 p-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 bg-white" placeholder="name@example.com" required>
                                </div>

                                <div class="space-y-1">
                                    <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Password</label>
                                    <input id="authPass" type="password" class="block w-full rounded-lg border border-gray-200 p-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 bg-white" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                                </div>
                                
                                <p id="loginError" class="text-xs text-red-500 hidden"></p>
                                
                                <button id="submitBtn" type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50">
                                    ${view === 'login' ? 'Sign In' : 'Create Account'}
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                
                // Re-attach listeners
                document.getElementById('tabLogin').onclick = () => { view = 'login'; renderForm(); };
                document.getElementById('tabSignup').onclick = () => { view = 'signup'; renderForm(); };
                document.getElementById('authForm').onsubmit = handleAuth;
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submitBtn');
                const err = document.getElementById('loginError');
                const email = document.getElementById('authEmail').value.trim();
                const pass = document.getElementById('authPass').value.trim();
                
                err.classList.add('hidden');
                btn.disabled = true;

                try {
                    if (view === 'signup') {
                        const username = document.getElementById('regUsername').value.trim();
                        const age = document.getElementById('regAge').value.trim();
                        const gender = document.getElementById('regGender').value;

                        if (username.length < 2) throw new Error("Username too short");

                        // Check Username Availability
                        const q = query(collection(db, "users"), where("usernameLower", "==", username.toLowerCase()));
                        const snap = await getDocs(q);
                        if (!snap.empty) throw new Error("Username already taken.");

                        // Create Auth User
                        const cred = await createUserWithEmailAndPassword(auth, email, pass);
                        const userId = cred.user.uid;

                        // Initial Role Logic
                        let role = 'vip';
                        if (username.toLowerCase() === 'developerr') role = 'developer';
                        const roleConfig = getRoleConfig(role);
                        const color = AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)];

                        // Create Firestore Doc
                        await setDoc(doc(db, "users", userId), {
                            username,
                            usernameLower: username.toLowerCase(),
                            email,
                            age,
                            gender,
                            color,
                            role,
                            banner: roleConfig.gradient,
                            likedBy: [],
                            joinedAt: serverTimestamp(),
                            lastSeen: serverTimestamp()
                        });

                        // CurrentUser will be set by onAuthStateChanged
                    } else {
                        // Sign In
                        await signInWithEmailAndPassword(auth, email, pass);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    let msg = error.message;
                    if (msg.includes('auth/invalid-credential') || msg.includes('auth/user-not-found')) msg = "Invalid email or password.";
                    else if (msg.includes('auth/email-already-in-use')) msg = "Email already registered.";
                    else if (msg.includes('auth/operation-not-allowed')) msg = "Sign-in method not enabled in Firebase Console.";
                    err.textContent = msg;
                    err.classList.remove('hidden');
                    btn.disabled = false;
                }
            };

            renderForm();
        }

        function renderChatRoom(container) {
            container.innerHTML = `
                <div class="flex h-screen w-full flex-col theme-bg-app md:flex-row text-sm">
                    <!-- LEFT Sidebar -->
                    <div id="sidebar" class="theme-bg-sidebar fixed inset-y-0 left-0 z-30 w-56 transform shadow-xl transition-transform duration-300 ease-in-out md:static md:translate-x-0 -translate-x-full border-r flex flex-col shrink-0">
                        <div class="border-b theme-border-primary p-4 flex items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold theme-text-primary">SimpleConnect</h2>
                                <p class="text-xs opacity-60">Global Room</p>
                            </div>
                        </div>
                        <div id="sidebarContent" class="flex-1 overflow-y-auto p-3 space-y-4"></div>
                        <div class="p-3 border-t theme-border-primary">
                            <button id="logoutBtn" class="flex w-full items-center justify-center rounded-lg border border-red-200 bg-red-50/10 px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50/20 transition-colors">
                                <i data-lucide="log-out" class="mr-2 w-3 h-3"></i> Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <div id="overlay" class="fixed inset-0 z-20 bg-black bg-opacity-50 md:hidden hidden"></div>

                    <!-- Main Chat -->
                    <div class="flex flex-1 flex-col overflow-hidden relative h-full">
                        <div class="flex items-center justify-between border-b theme-bg-sidebar p-3 shadow-sm md:hidden shrink-0">
                            <h1 class="text-lg font-bold theme-text-primary">SimpleConnect</h1>
                             <div class="flex items-center space-x-2">
                                <button id="menuBtn" class="p-2 opacity-70 hover:opacity-100">
                                    <i data-lucide="menu" class="w-5 h-5"></i>
                                </button>
                             </div>
                        </div>

                        <div id="messagesList" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 scroll-smooth"></div>
                        <div id="typingIndicator" class="px-4 py-1.5 min-h-[1.5rem] text-[10px] opacity-60 italic flex items-center shrink-0"></div>

                        <!-- Input Area with Mention Dropdown -->
                        <div class="theme-bg-sidebar p-3 border-t theme-border-primary shrink-0 relative">
                            <div id="mentionDropdown" class="absolute bottom-full left-3 mb-1 bg-white border border-gray-200 rounded-lg shadow-xl w-48 hidden overflow-hidden z-50"></div>

                            <form id="messageForm" class="mx-auto max-w-4xl relative">
                                <input id="messageInput" type="text" 
                                    placeholder="Message... (@ to mention)" 
                                    class="w-full rounded-full border px-4 py-2 pr-20 theme-input focus:outline-none focus:ring-1 focus:ring-opacity-50 theme-border-primary text-sm shadow-sm" 
                                    autocomplete="off" 
                                    style="--tw-ring-color: var(--primary);">
                                
                                <div class="absolute right-1.5 top-1 flex space-x-1">
                                    <button type="button" id="uploadImgBtn" class="p-1.5 rounded-full text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition-colors" title="Upload Image">
                                        <i data-lucide="paperclip" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button type="submit" id="sendBtn" class="rounded-full theme-primary p-1.5 transition-transform hover:scale-105 disabled:opacity-50 disabled:scale-100">
                                        <i data-lucide="send" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- RIGHT Sidebar -->
                    <div id="rightSidebar" class="hidden lg:flex w-60 flex-col border-l theme-bg-sidebar theme-border-primary shrink-0">
                         <div class="p-4 border-b theme-border-primary">
                            <h3 class="text-xs font-bold uppercase tracking-wider opacity-70">Online Users</h3>
                         </div>
                         <div id="onlineUsersList" class="flex-1 overflow-y-auto p-2"></div>
                    </div>
                    
                    <div id="themeModalContainer"></div>
                    <div id="profileModalContainer"></div>
                </div>
            `;

            renderSidebar();
            renderRightSidebar();

            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('translate-x-0');
                overlay.classList.toggle('hidden');
            };
            if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);
            if (overlay) overlay.addEventListener('click', toggleSidebar);

            document.getElementById('logoutBtn').addEventListener('click', () => {
                signOut(auth).then(() => {
                    localStorage.removeItem('chat_user');
                    // onAuthStateChanged will handle the rest
                });
            });

            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');

            messageInput.addEventListener('input', (e) => {
                const val = e.target.value;
                
                // Typing Indicator logic
                if (val.trim()) {
                    const now = Date.now();
                    if (now - lastTypingSent > 2500) {
                        setDoc(doc(db, "typing", currentUser.id), {
                            userId: currentUser.id,
                            username: currentUser.username,
                            timestamp: serverTimestamp()
                        });
                        lastTypingSent = now;
                    }
                }
                
                // Mention Logic
                const lastAt = val.lastIndexOf('@');
                if (lastAt !== -1) {
                    const query = val.substring(lastAt + 1);
                    // Check if there's a space after @, if so, stop suggesting
                    if (!query.includes(' ')) {
                        mentionQuery = query.toLowerCase();
                        mentionIndex = lastAt + 1;
                        renderMentionDropdown();
                    } else {
                        mentionQuery = null;
                        renderMentionDropdown();
                    }
                } else {
                    mentionQuery = null;
                    renderMentionDropdown();
                }
            });

            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                
                // Handle Commands
                if (text.startsWith('/')) {
                     messageInput.value = '';
                     mentionQuery = null;
                     renderMentionDropdown();
                     
                     const args = text.slice(1).trim().split(' ');
                     const command = args[0].toLowerCase();
                     const highStaff = ['developer', 'founder', 'head owner'];
                     const userRole = (currentUser.role || '').toLowerCase();
                     
                     if (command === 'clear') {
                        if (!highStaff.includes(userRole)) {
                            showToast("Permission denied.", 'error');
                            return;
                        }
                        try {
                            // Using batch for better reliability and performance
                            const snap = await getDocs(collection(db, "messages"));
                            const batch = writeBatch(db);
                            let count = 0;
                            
                            snap.docs.forEach(d => {
                                batch.delete(d.ref);
                                count++;
                            });
                            
                            if (count > 0) {
                                await batch.commit();
                                await logAction('message_delete_all', `Cleared ${count} messages`);
                                showToast(`Cleared ${count} messages.`);
                            } else {
                                showToast("Chat is already empty.");
                            }
                        } catch(err) { console.error(err); showToast("Error clearing chat", 'error'); }
                        return;
                     }
                     
                     if (command === 'rank') {
                        if (!highStaff.includes(userRole)) {
                            showToast("Permission denied.", 'error');
                            return;
                        }
                        const targetName = args[1];
                        const newRankStr = args.slice(2).join(' '); // Ranks can have spaces
                        
                        if (!targetName || !newRankStr) {
                            showToast("Usage: /rank {username} {RankName}", 'error');
                            return;
                        }
                        
                        try {
                            const q = query(collection(db, "users"), where("usernameLower", "==", targetName.toLowerCase()));
                            const snap = await getDocs(q);
                            if (snap.empty) {
                                showToast("User not found.", 'error');
                                return;
                            }
                            const targetUser = snap.docs[0];
                            // Update user
                            await updateDoc(doc(db, "users", targetUser.id), { role: newRankStr.toLowerCase() });
                            await logAction('rank_change', `Changed ${targetUser.data().username}'s rank to ${newRankStr}`);
                            showToast("Action complete");
                        } catch(err) { console.error(err); showToast("Error updating rank", 'error'); }
                        return;
                     }
                     
                     showToast("Invalid command", 'error');
                     return;
                }

                if (!text && !pendingChatImage) return;
                
                messageInput.value = '';
                mentionQuery = null;
                renderMentionDropdown();
                
                const imgToSend = pendingChatImage;
                pendingChatImage = null;
                document.getElementById('uploadImgBtn').classList.remove('text-green-600', 'bg-green-100');

                try {
                    await addDoc(collection(db, "messages"), {
                        text: text,
                        image: imgToSend,
                        senderId: currentUser.id,
                        senderName: currentUser.username,
                        senderColor: currentUser.color,
                        timestamp: serverTimestamp(),
                        edited: false,
                        reactions: {} // Initialize reactions map to ensure updates work
                    });
                } catch (err) {
                    console.error("Error sending", err);
                }
            });
            
            renderChatMessages();
            renderNotificationsPanel();
        }

        function renderNotificationsPanel() {
            let container = document.getElementById('notificationPanel');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            // Update dot
            const badge = document.getElementById('notifBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            if (!container) {
                // Should be created inside sidebar container, actually let's append it to the body or sidebar relative
                // Since sidebar has overflow-y auto, it might clip. Let's make it a fixed overlay or append to specific place.
                // Best place is inside the sidebar logic.
                return;
            }
            
            if (notifications.length === 0) {
                container.innerHTML = `<div class="p-4 text-center opacity-50 text-xs italic">No notifications</div>`;
                return;
            }
            
            container.innerHTML = notifications.map(n => {
                let icon = 'info';
                let color = 'text-gray-500';
                if (n.type === 'view') { icon = 'eye'; color = 'text-blue-500'; }
                if (n.type === 'like') { icon = 'heart'; color = 'text-red-500'; }
                if (n.type === 'reaction') { icon = 'smile'; color = 'text-orange-500'; }
                if (n.type === 'rank') { icon = 'shield'; color = 'text-purple-500'; }
                
                const time = n.timestamp ? new Date(n.timestamp.toMillis()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                return `
                <div class="flex items-start p-2 hover:bg-black/5 rounded-lg transition-colors mb-1 ${!n.read ? 'bg-blue-50/50' : ''}">
                    <div class="mt-0.5 mr-2 ${color}"><i data-lucide="${icon}" class="w-3.5 h-3.5"></i></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-800 leading-snug">${escapeHtml(n.content)}</p>
                        <p class="text-[10px] text-gray-400 mt-0.5">${time}</p>
                    </div>
                </div>
                `;
            }).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        function renderMentionDropdown() {
            const dropdown = document.getElementById('mentionDropdown');
            if (!dropdown) return;

            if (!mentionQuery && mentionQuery !== '') {
                dropdown.classList.add('hidden');
                return;
            }

            const matches = onlineUsers.filter(u => u.username.toLowerCase().startsWith(mentionQuery));
            if (matches.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.innerHTML = matches.map(u => `
                <div class="mention-item flex items-center p-2 hover:bg-gray-100 cursor-pointer" data-username="${u.username}">
                     <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] text-white font-bold mr-2 ${u.color}">
                        ${u.username.substring(0,2).toUpperCase()}
                     </div>
                     <span class="text-sm font-medium text-gray-800">${u.username}</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            if (!container) return;
            const safeUsername = escapeHtml(currentUser.username);
            
            const avatarHtml = currentUser.avatarImage 
                ? `<img src="${currentUser.avatarImage}" class="h-8 w-8 rounded-full object-cover shadow-sm">` 
                : `<div class="flex h-8 w-8 items-center justify-center rounded-full text-white font-bold shadow-sm ${currentUser.color} text-xs">${safeUsername.substring(0, 2).toUpperCase()}</div>`;
            
            const statusHtml = currentUser.status 
                ? `<p class="text-[10px] text-gray-500 truncate max-w-[140px]">"${escapeHtml(currentUser.status)}"</p>` 
                : `<div class="flex items-center text-[10px] text-green-500"><span class="mr-1 h-1 w-1 rounded-full bg-green-500"></span> Online</div>`;

            container.innerHTML = `
                <div>
                    <h3 class="mb-2 text-[10px] font-semibold uppercase tracking-wider opacity-50">My Profile</h3>
                    <div class="user-profile-trigger flex items-center space-x-3 rounded-lg bg-gray-100/10 p-2 border border-gray-200/20 cursor-pointer hover:bg-gray-100/20 transition-colors" data-user-id="${currentUser.id}">
                        ${avatarHtml}
                        <div class="overflow-hidden">
                            <p class="font-semibold text-xs truncate">${safeUsername}</p>
                            ${statusHtml}
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="mb-2 text-[10px] font-semibold uppercase tracking-wider opacity-50">Settings</h3>
                    
                    <button id="notificationBtn" class="w-full flex items-center space-x-3 rounded-lg p-2 hover:bg-gray-100/10 transition-colors text-left border border-transparent hover:border-gray-200/20 relative">
                        <div class="flex h-6 w-6 items-center justify-center rounded-full bg-red-50 text-red-500 relative">
                            <i data-lucide="bell" class="w-3 h-3"></i>
                            <span id="notifBadge" class="notif-dot hidden"></span>
                        </div>
                        <div>
                            <p class="font-medium text-xs">Notifications</p>
                            <p class="text-[10px] opacity-60">Activity & Alerts</p>
                        </div>
                    </button>
                    <!-- Notification Panel (Hidden) -->
                    <div id="notificationPanel" class="hidden mt-1 mx-1 bg-white border border-gray-200 shadow-inner rounded-lg p-1 max-h-48 overflow-y-auto">
                        <div class="text-center p-2 text-xs text-gray-400">Loading...</div>
                    </div>

                    <button id="themeBtn" class="w-full flex items-center space-x-3 rounded-lg p-2 mt-2 hover:bg-gray-100/10 transition-colors text-left border border-transparent hover:border-gray-200/20">
                        <div class="flex h-6 w-6 items-center justify-center rounded-full theme-primary">
                            <i data-lucide="palette" class="w-3 h-3 text-white"></i>
                        </div>
                        <div>
                            <p class="font-medium text-xs">Themes</p>
                            <p class="text-[10px] opacity-60">Customization</p>
                        </div>
                    </button>
                    ${currentUser.role === 'developer' ? `
                    <button id="adminPanelBtn" class="w-full flex items-center space-x-3 rounded-lg p-2 mt-2 hover:bg-gray-100/10 transition-colors text-left border border-transparent hover:border-gray-200/20 text-red-600">
                        <div class="flex h-6 w-6 items-center justify-center rounded-full bg-red-100">
                            <i data-lucide="shield-alert" class="w-3 h-3 text-red-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-xs">Panel</p>
                            <p class="text-[10px] opacity-60">Developer Access</p>
                        </div>
                    </button>
                    ` : ''}
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
            
            // Re-render notifications into the new container
            renderNotificationsPanel();
        }

        function renderRightSidebar() {
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<div class="p-3 text-center opacity-50 text-xs italic">Looking for users...</div>';
                return;
            }

            container.innerHTML = onlineUsers.map(u => {
                const role = getRoleConfig(u.role);
                const avatarHtml = u.avatarImage 
                    ? `<img src="${u.avatarImage}" class="h-8 w-8 rounded-full object-cover shadow-sm">`
                    : `<div class="flex h-8 w-8 items-center justify-center rounded-full text-white font-bold shadow-sm ${u.color || 'bg-gray-500'} text-xs">${escapeHtml(u.username).substring(0, 2).toUpperCase()}</div>`;
                
                // Rank Badge HTML
                const rankBadge = `<span class="ml-1 inline-flex items-center justify-center rounded-full ${role.bg} p-0.5 border ${role.border}" title="${role.label}"><i data-lucide="${role.icon}" class="w-3 h-3 ${role.color} ${role.fill}"></i></span>`;

                return `
                <div class="user-profile-trigger flex items-center p-2 mb-1 hover:bg-black/5 rounded-lg transition-colors cursor-pointer group" data-user-id="${u.id}">
                   <div class="relative shrink-0">
                      ${avatarHtml}
                      <div class="absolute bottom-0 right-0 h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-white ring-1 ring-gray-100"></div>
                   </div>
                   <div class="ml-2.5 min-w-0 flex-1 overflow-hidden">
                      <div class="flex items-center">
                          <p class="text-xs font-semibold truncate max-w-[100px] ${u.id === currentUser.id ? 'theme-text-primary' : 'theme-text-main'}">
                              ${escapeHtml(u.username)}
                          </p>
                          ${rankBadge}
                      </div>
                      ${u.status ? `<p class="text-[10px] text-gray-500 truncate">"${escapeHtml(u.status)}"</p>` : `<p class="text-[9px] text-green-600 font-medium">Online</p>`}
                   </div>
                </div>
            `}).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        function renderThemeModal() {
            const container = document.getElementById('themeModalContainer');
            if (!container) return;

            if (!showThemeModal) { container.innerHTML = ''; return; }

            const t = themes.find(x => x.id === previewThemeId) || themes[0];
            const previewStyle = `
                --primary: ${t.primary};
                --bg-app: ${t.bgApp};
                --bg-sidebar: ${t.bgSidebar};
                --text-main: ${t.text};
                --msg-bubble-me: ${t.primary};
                --msg-text-me: #ffffff;
                --border-color: ${t.borderColor};
            `;

            container.innerHTML = `
                <div id="themeOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 backdrop-blur-sm">
                    <div class="w-full max-w-5xl h-[85vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                            <div><h2 class="text-lg font-bold text-gray-900">Choose a Theme</h2><p class="text-xs text-gray-500">Preview before you apply</p></div>
                            <div class="flex items-center space-x-2">
                                <button id="applyThemeBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition-colors">Apply Theme</button>
                                <button id="closeThemeBtn" class="p-2 hover:bg-gray-200 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-1 overflow-hidden">
                            <div class="w-1/3 border-r bg-gray-100 hidden md:flex flex-col p-4 overflow-hidden relative">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Live Preview</h3>
                                <div class="flex-1 rounded-xl shadow-lg flex flex-col overflow-hidden border theme-scope relative" style="${previewStyle}">
                                    <div class="h-10 border-b theme-bg-sidebar flex items-center px-3 space-x-2 shrink-0">
                                        <div class="w-2.5 h-2.5 rounded-full bg-red-400"></div><div class="w-2.5 h-2.5 rounded-full bg-yellow-400"></div><div class="w-2.5 h-2.5 rounded-full bg-green-400"></div>
                                    </div>
                                    <div class="flex-1 p-3 space-y-3 overflow-hidden theme-bg-app relative">
                                        <div class="flex items-end"><div class="w-6 h-6 rounded-full bg-indigo-500 mr-2 shrink-0"></div><div class="theme-bg-sidebar p-2 rounded-xl rounded-tl-none border shadow-sm text-xs max-w-[80%]"><p class="theme-text-main opacity-90">How does this look?</p></div></div>
                                        <div class="flex flex-row-reverse items-end"><div class="theme-primary p-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[80%] text-white"><p>Looks awesome! ðŸ˜Ž</p></div></div>
                                    </div>
                                    <div class="h-12 theme-bg-sidebar border-t p-2 shrink-0"><div class="h-full rounded-full border opacity-50 mx-auto w-full"></div></div>
                                </div>
                                <div class="mt-4 text-center"><span class="text-sm font-bold text-gray-700">${t.name}</span></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 bg-white">
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                    ${themes.map(th => `
                                        <button class="theme-option group relative flex flex-col rounded-lg border-2 p-1.5 transition-all hover:shadow-md ${previewThemeId === th.id ? 'border-blue-600 ring-1 ring-blue-100 bg-blue-50/50' : 'border-gray-100 hover:border-gray-300 bg-white'}" data-id="${th.id}">
                                            <div class="w-full h-16 rounded mb-2 relative overflow-hidden shadow-sm border border-black/5" style="background-color: ${th.bgApp}"><div class="absolute left-0 top-0 bottom-0 w-1/4" style="background-color: ${th.bgSidebar}"></div><div class="absolute right-2 bottom-2 w-6 h-6 rounded-full shadow-sm" style="background-color: ${th.primary}"></div></div>
                                            <span class="text-[10px] font-semibold text-gray-600 group-hover:text-gray-900 text-center">${th.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function renderProfileModal() {
            const container = document.getElementById('profileModalContainer');
            if (!container) return;

            if (!showProfileModal) { container.innerHTML = ''; return; }

            const data = viewingProfileData || { username: 'Loading...', color: 'bg-gray-200', role: 'vip', likedBy: [] };
            const role = getRoleConfig(data.role);
            
            const banner = isEditingProfile 
                ? (editProfileForm.bannerImage ? `url(${editProfileForm.bannerImage})` : (editProfileForm.banner || getRoleConfig(viewingProfileData.role).gradient))
                : (data.bannerImage ? `url(${data.bannerImage})` : (data.banner || role.gradient));
                
            const isBannerImage = (isEditingProfile && editProfileForm.bannerImage) || (!isEditingProfile && data.bannerImage);
            const avatarImage = isEditingProfile ? editProfileForm.avatarImage : data.avatarImage;
            const color = isEditingProfile ? editProfileForm.color : data.color;
            const username = isEditingProfile ? editProfileForm.username : data.username;
            const joinDate = data.joinedAt ? formatDate(data.joinedAt) : 'Unknown';
            const lastSeen = data.lastSeen ? new Date(data.lastSeen.toMillis ? data.lastSeen.toMillis() : data.lastSeen).toLocaleString() : 'Never';
            const isMe = currentUser && currentUser.id === viewingProfileId;
            const likedBy = data.likedBy || [];
            const isLiked = currentUser && likedBy.includes(currentUser.id);
            const likeCount = likedBy.length;
            const bannerStyle = isBannerImage ? `background-image: ${banner}; background-size: cover; background-position: center;` : '';
            const bannerClass = isBannerImage ? `h-32 relative bg-gray-200` : `h-32 bg-gradient-to-r ${banner} relative`;

            container.innerHTML = `
                <div id="profileOverlay" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-60 p-4 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]">
                     <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-visible transform transition-all scale-100 relative max-h-[90vh] overflow-y-auto">
                        <button id="closeProfileBtn" class="absolute top-4 right-4 z-10 p-2 bg-black/20 hover:bg-black/30 rounded-full text-white transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>

                        <div id="${isEditingProfile ? 'editBannerTrigger' : ''}" class="rounded-t-3xl ${bannerClass} ${isEditingProfile ? 'cursor-pointer hover:opacity-90 group' : ''}" style="${bannerStyle}">
                             ${isEditingProfile ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity rounded-t-3xl"><i data-lucide="image" class="text-white w-8 h-8 drop-shadow-lg"></i></div>' : ''}
                             <div class="absolute left-1/2 -translate-x-1/2 -bottom-12">
                                <div id="${isEditingProfile ? 'editAvatarTrigger' : ''}" class="h-24 w-24 rounded-full border-[4px] border-white shadow-lg overflow-hidden flex items-center justify-center text-3xl font-bold text-white bg-white relative ${isEditingProfile ? 'cursor-pointer hover:opacity-90 group' : ''}">
                                    ${avatarImage 
                                        ? `<img src="${avatarImage}" class="w-full h-full object-cover">` 
                                        : `<div class="w-full h-full flex items-center justify-center ${color}">${escapeHtml(username).substring(0,2).toUpperCase()}</div>`
                                    }
                                    ${isEditingProfile ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="camera" class="text-white w-6 h-6 drop-shadow-lg"></i></div>' : ''}
                                </div>
                             </div>
                        </div>
                        
                        <div class="px-6 pb-6 pt-16 relative text-center">
                            <!-- Hidden YouTube Player Container (Opacity 0 to allow playback) -->
                            <div id="hidden-player" class="absolute opacity-0 pointer-events-none w-1 h-1 overflow-hidden"></div>
                        
                            ${(!isEditingProfile && data.youtubeId) ? `
                                <div class="mb-4 mx-auto w-full max-w-[90%] bg-gray-900 rounded-xl p-2.5 flex items-center justify-between shadow-lg ring-1 ring-gray-800">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-8 w-8 rounded-lg bg-red-600 flex items-center justify-center shadow-inner">
                                            <i data-lucide="youtube" class="text-white w-4 h-4"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest leading-none mb-0.5">Profile Anthem</p>
                                            <p class="text-xs font-bold text-white flex items-center space-x-1">
                                                <span>YouTube Music</span>
                                                ${isMusicPlaying ? `
                                                    <span class="flex space-x-0.5 items-end h-3">
                                                        <span class="w-0.5 bg-green-400 eq-bar"></span>
                                                        <span class="w-0.5 bg-green-400 eq-bar"></span>
                                                        <span class="w-0.5 bg-green-400 eq-bar"></span>
                                                    </span>
                                                ` : ''}
                                            </p>
                                        </div>
                                    </div>
                                    <button id="toggleMusicBtn" class="h-8 w-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition-colors">
                                        <i data-lucide="${isMusicPlaying ? 'pause' : 'play'}" class="w-4 h-4 fill-current"></i>
                                    </button>
                                </div>
                            ` : ''}

                            ${isMe && !isEditingProfile ? `
                                <button id="editProfileBtn" class="absolute top-4 right-6 px-4 py-1.5 rounded-full border border-gray-300 text-xs font-bold text-gray-700 hover:bg-gray-50 transition-colors">
                                    Edit Profile
                                </button>
                            ` : ''}

                            <div>
                                ${isEditingProfile ? `
                                    <div class="space-y-4 text-left">
                                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Display Name</label>
                                            <input id="editUsernameInput" type="text" value="${escapeHtml(editProfileForm.username)}" class="w-full bg-white border border-gray-300 rounded p-2 text-sm font-bold text-gray-900 outline-none" autocomplete="off" placeholder="Enter username...">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Age</label>
                                                <input id="editAgeInput" type="number" value="${escapeHtml(editProfileForm.age)}" class="w-full bg-white border border-gray-300 rounded p-2 text-sm text-gray-700 outline-none" autocomplete="off" placeholder="Age">
                                            </div>
                                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Gender</label>
                                                <select id="editGenderInput" class="w-full bg-white border border-gray-300 rounded p-2 text-sm text-gray-700 outline-none">
                                                    <option value="" ${editProfileForm.gender === '' ? 'selected' : ''}>Select</option>
                                                    <option value="Male" ${editProfileForm.gender === 'Male' ? 'selected' : ''}>Male</option>
                                                    <option value="Female" ${editProfileForm.gender === 'Female' ? 'selected' : ''}>Female</option>
                                                    <option value="Non-binary" ${editProfileForm.gender === 'Non-binary' ? 'selected' : ''}>Non-binary</option>
                                                    <option value="Other" ${editProfileForm.gender === 'Other' ? 'selected' : ''}>Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Custom Status</label>
                                            <input id="editStatusInput" type="text" value="${escapeHtml(editProfileForm.status)}" class="w-full bg-white border border-gray-300 rounded p-2 text-sm text-gray-700 outline-none" autocomplete="off" placeholder="What's on your mind?">
                                        </div>
                                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Profile Anthem (YouTube)</label>
                                            <div class="flex items-center space-x-2">
                                                <i data-lucide="youtube" class="w-4 h-4 text-red-600"></i>
                                                <input id="editYoutubeInput" type="text" value="${escapeHtml(editProfileForm.youtubeId)}" class="flex-1 bg-white border border-gray-300 rounded p-2 text-sm text-gray-700 outline-none" autocomplete="off" placeholder="Paste YouTube Link or ID">
                                            </div>
                                        </div>
                                        <p id="editProfileError" class="text-red-500 text-xs font-semibold hidden"></p>
                                    </div>
                                ` : `
                                    <div class="flex flex-col items-center justify-center space-y-1">
                                        <h2 class="text-2xl font-black text-gray-900 leading-tight">${escapeHtml(username)}</h2>
                                        ${data.status ? `<div class="bg-gray-100 px-3 py-1 rounded-full text-xs text-gray-600 italic">"${escapeHtml(data.status)}"</div>` : ''}
                                        <div class="flex items-center space-x-2 mt-1 text-xs text-gray-500">
                                            ${data.age ? `<span>${escapeHtml(data.age)} yrs</span>` : ''}
                                            ${data.age && data.gender ? '<span>â€¢</span>' : ''}
                                            ${data.gender ? `<span>${escapeHtml(data.gender)}</span>` : ''}
                                        </div>

                                        ${!isMe ? `
                                            <div class="flex items-center justify-center space-x-4 mt-4 mb-2">
                                                <button id="profileLikeBtn" class="flex flex-col items-center group">
                                                    <div class="w-10 h-10 rounded-full flex items-center justify-center transition-all ${isLiked ? 'bg-red-50 text-red-500 border border-red-200' : 'bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-400'}">
                                                        <i data-lucide="heart" class="w-5 h-5 ${isLiked ? 'fill-current' : ''}"></i>
                                                    </div>
                                                    <span class="text-[10px] font-bold text-gray-400 mt-1">${likeCount}</span>
                                                </button>
                                            </div>
                                        ` : `
                                             <div class="flex items-center justify-center space-x-2 mt-4 mb-2">
                                                 <div class="flex items-center space-x-1 text-red-400 bg-red-50 px-3 py-1 rounded-full border border-red-100">
                                                    <i data-lucide="heart" class="w-3 h-3 fill-current"></i>
                                                    <span class="text-xs font-bold">${likeCount} Likes</span>
                                                 </div>
                                             </div>
                                        `}
                                    </div>
                                `}

                                <div class="mt-2 flex justify-center">
                                     <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${role.bg} ${role.color} border ${role.border} uppercase tracking-wide">
                                        <i data-lucide="${role.icon}" class="w-3.5 h-3.5 mr-1.5 ${role.fill}"></i> ${role.label}
                                    </span>
                                </div>
                                
                                ${isEditingProfile ? `
                                    <div class="mt-8 flex space-x-2">
                                        <button id="saveProfileBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-bold shadow-sm">Save Changes</button>
                                        <button id="cancelEditProfileBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-bold">Cancel</button>
                                    </div>
                                ` : `
                                    <div class="mt-8 grid grid-cols-2 gap-4 border-t pt-6">
                                        <div class="flex flex-col">
                                            <span class="text-[10px] uppercase tracking-wider text-gray-400 font-bold">Joined</span>
                                            <span class="text-sm font-semibold text-gray-700">${joinDate}</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-[10px] uppercase tracking-wider text-gray-400 font-bold">Last Seen</span>
                                            <span class="text-sm font-semibold text-gray-700">${lastSeen}</span>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                     </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function getMessageHTML(msg, isMe, safeName) {
            let cleanHtml = '';
            if (window.marked && window.DOMPurify) { 
                try { cleanHtml = window.DOMPurify.sanitize(window.marked.parse(msg.text || '')); } 
                catch (e) { cleanHtml = escapeHtml(msg.text || ''); } 
            } else { cleanHtml = escapeHtml(msg.text || ''); }
            
            cleanHtml = cleanHtml.replace(/(@\w+)/g, (match) => {
                const mentionedName = match.substring(1).toLowerCase();
                const isMeMentioned = mentionedName === currentUser.username.toLowerCase();
                if (isMeMentioned) {
                    return `<span class="mention-me">${match}</span>`;
                }
                return `<span class="mention">${match}</span>`;
            });

            // Image handling
            let imageHtml = '';
            if (msg.image) {
                imageHtml = `<img src="${msg.image}" class="chat-image" alt="attachment" onclick="window.open(this.src, '_blank')">`;
            }

            let avatarSrc = null;
            if(msg.senderId === currentUser.id) avatarSrc = currentUser.avatarImage;
            else {
                const online = onlineUsers.find(u => u.id === msg.senderId);
                if(online) avatarSrc = online.avatarImage;
            }
            
            const avatarHtml = avatarSrc 
                ? `<img src="${avatarSrc}" class="h-7 w-7 rounded-full object-cover shadow-sm ${isMe ? 'ml-2' : 'mr-2'} mb-1 cursor-pointer transition-transform hover:scale-110 user-profile-trigger" data-user-id="${msg.senderId}">`
                : `<div class="user-profile-trigger flex h-7 w-7 shrink-0 items-center justify-center rounded-full text-[10px] font-bold text-white shadow-sm ${msg.senderColor || 'bg-gray-500'} ${isMe ? 'ml-2' : 'mr-2'} mb-1 cursor-pointer transition-transform hover:scale-110" data-user-id="${msg.senderId}">${safeName.substring(0, 2).toUpperCase()}</div>`;
            
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
            const isMentionedContainer = msg.text.toLowerCase().includes(`@${currentUser.username.toLowerCase()}`);
            const containerStyle = isMentionedContainer ? 'ring-2 ring-yellow-300 bg-yellow-50/10' : '';

            // Reactions Rendering
            let reactionsHtml = '';
            if (msg.reactions) {
                const pills = [];
                for (const [emoji, users] of Object.entries(msg.reactions)) {
                    if (users && users.length > 0) {
                        const isActive = users.includes(currentUser.id);
                        pills.push(`
                            <button class="reaction-pill reaction-btn-trigger ${isActive ? 'active' : ''}" data-id="${msg.id}" data-emoji="${emoji}">
                                ${emoji} <span class="ml-1 opacity-70 font-semibold">${users.length}</span>
                            </button>
                        `);
                    }
                }
                if (pills.length > 0) {
                    reactionsHtml = `<div class="flex flex-wrap mt-1.5 -ml-1">${pills.join('')}</div>`;
                }
            }

            // Reaction Menu in Actions
            const reactionMenuHtml = REACTIONS_LIST.map(e => `
                <button class="reaction-btn-trigger p-1 hover:scale-125 transition-transform" data-id="${msg.id}" data-emoji="${e}">${e}</button>
            `).join('');

            return `
                <div class="flex max-w-[90%] md:max-w-[75%] ${isMe ? 'flex-row-reverse' : 'flex-row'} relative items-end">
                    ${avatarHtml}
                    ${isMe ? `<div class="msg-actions absolute top-1/2 -translate-y-1/2 flex items-center space-x-1 z-10 ${isMe ? '-left-auto right-full pr-2' : '-right-auto left-full pl-2'}">
                        <div class="flex bg-white border border-gray-200 rounded-full shadow-sm px-1 py-0.5 mr-2 space-x-0.5">${reactionMenuHtml}</div>
                        <button class="btn-start-edit p-1 text-gray-500 hover:text-blue-600 rounded-full bg-white shadow-sm border border-gray-200 hover:border-blue-300 transition-all hover:scale-110" data-id="${msg.id}"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        <button class="btn-delete p-1 text-gray-500 hover:text-red-600 rounded-full bg-white shadow-sm border border-gray-200 hover:border-red-300 transition-all hover:scale-110" data-id="${msg.id}"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>` 
                    : `<div class="msg-actions absolute top-1/2 -translate-y-1/2 flex items-center space-x-1 z-10 -right-auto left-full pl-2">
                        <div class="flex bg-white border border-gray-200 rounded-full shadow-sm px-1 py-0.5 space-x-0.5">${reactionMenuHtml}</div>
                    </div>`}
                    
                    <div class="relative rounded-xl px-3 py-2 shadow-sm ${isMe ? 'rounded-tr-none bubble-me bg-me' : 'rounded-tl-none bubble-other'} min-w-[50px] ${containerStyle}">
                        ${!isMe ? `<p class="user-profile-trigger mb-0.5 text-[9px] font-bold opacity-60 uppercase tracking-wide cursor-pointer hover:underline" data-user-id="${msg.senderId}">${safeName}</p>` : ''}
                        ${imageHtml}
                        <div class="markdown-content text-xs md:text-sm leading-relaxed break-words">${cleanHtml}</div>
                        ${reactionsHtml}
                        <div class="flex items-center justify-end mt-0.5 space-x-1 opacity-60 border-t ${isMe ? 'border-white/20' : 'border-black/5'} pt-0.5">
                            ${msg.edited ? '<span class="text-[8px] italic">(edited)</span>' : ''}
                            <span class="text-[9px]">${time}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Smart Diffing Render
        function renderChatMessages() {
            const list = document.getElementById('messagesList');
            if (!list) return;
            
            if (messages.length === 0) {
                list.innerHTML = `<div class="flex h-full flex-col items-center justify-center text-center opacity-40"><div class="mb-4 rounded-full bg-gray-200 p-4"><i data-lucide="message-square-dashed" class="w-8 h-8"></i></div><h3 class="text-base font-medium">No messages</h3><p class="text-xs">Say hello!</p></div>`;
                return;
            }

            // Remove placeholder if present
            if(list.querySelector('.text-center.opacity-40')) list.innerHTML = '';

            const currentIds = new Set(messages.map(m => m.id));
            let addedNewMessage = false;

            // 1. Remove deleted messages
            Array.from(list.children).forEach(child => {
                 const id = child.id.replace('msg-', '');
                 if (id && !currentIds.has(id)) {
                     child.remove();
                 }
            });

            // 2. Add or Update messages
            messages.forEach(msg => {
                const elId = `msg-${msg.id}`;
                let el = document.getElementById(elId);
                const isMe = msg.senderId === currentUser.id;
                const safeName = escapeHtml(msg.senderName);
                
                // If editing this specific message, show edit UI (simple re-render for this case)
                if (editingMessageId === msg.id) {
                     if (!el) {
                         el = document.createElement('div');
                         el.id = elId;
                         list.appendChild(el);
                     }
                     el.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-3`;
                     el.innerHTML = `<div class="flex max-w-[95%] md:max-w-[80%] ${isMe ? 'flex-row-reverse' : 'flex-row'} items-start"><div class="flex-1 min-w-0 bg-white rounded-lg border border-blue-200 p-2 shadow-lg z-10"><textarea class="edit-input w-full p-2 mb-1 text-xs border border-gray-200 rounded focus:border-blue-500 focus:outline-none text-gray-800 bg-gray-50 resize-none" rows="2" data-id="${msg.id}" autofocus>${escapeHtml(msg.text)}</textarea><div class="flex justify-end space-x-1"><button class="btn-cancel-edit text-[10px] px-2 py-1 text-gray-500 hover:bg-gray-100 rounded">Cancel</button><button class="btn-save-edit text-[10px] px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" data-id="${msg.id}">Save</button></div></div></div>`;
                     return;
                }

                // Normal Message View
                const contentHtml = getMessageHTML(msg, isMe, safeName);
                
                if (!el) {
                    // Create New
                    el = document.createElement('div');
                    el.id = elId;
                    el.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} group message-group`;
                    el.innerHTML = contentHtml;
                    el.dataset.ts = msg.timestamp;
                    el.dataset.edited = msg.edited;
                    list.appendChild(el);
                    addedNewMessage = true;
                } else {
                    // Update if changed
                    el.innerHTML = contentHtml;
                    el.dataset.ts = msg.timestamp;
                    el.dataset.edited = msg.edited;
                }
            });
            
            // Auto-scroll on new message
            if (addedNewMessage) {
                 setTimeout(() => list.scrollTop = list.scrollHeight, 50);
            }

            if(window.lucide) window.lucide.createIcons();
        }

        function updateTypingUI() {
            const indicator = document.getElementById('typingIndicator');
            if (!indicator) return;
            const now = Date.now();
            const active = Object.values(typingUsers).filter(u => now - u.timestamp < 3000).map(u => escapeHtml(u.username));
            if (active.length > 0) {
                const text = active.length === 1 ? `${active[0]} is typing` : active.length === 2 ? `${active[0]} & ${active[1]} are typing` : `${active.length} people typing`;
                indicator.innerHTML = `<span class="mr-1">${text}</span><span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span><span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span><span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span>`;
            } else { indicator.innerHTML = ''; }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
