<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleConnect Chat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- HTML Sanitizer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-app: #f3f4f6;
            --bg-sidebar: #ffffff;
            --text-main: #111827;
            --msg-bubble-me: #2563eb;
            --msg-text-me: #ffffff;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Message Actions Visibility */
        .message-group:hover .msg-actions { opacity: 1; pointer-events: auto; }
        .msg-actions { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        @media (hover: none) {
            .msg-actions { opacity: 1; pointer-events: auto; }
        }

        /* Markdown Styles within Chat Bubbles */
        .markdown-content p { margin-bottom: 0.5em; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content strong { font-weight: 700; }
        .markdown-content em { font-style: italic; }
        .markdown-content code { 
            background: rgba(0,0,0,0.1); 
            padding: 0.1em 0.3em; 
            border-radius: 3px; 
            font-family: monospace; 
            font-size: 0.9em;
        }
        .bg-me .markdown-content code {
            background: rgba(255,255,255,0.2);
        }
        .markdown-content pre {
            background: rgba(0,0,0,0.1);
            padding: 0.5em;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        .bg-me .markdown-content pre {
            background: rgba(0,0,0,0.2);
        }
        .markdown-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.5em; }
        .markdown-content blockquote { border-left: 3px solid rgba(0,0,0,0.2); padding-left: 0.5em; margin-left: 0.2em; opacity: 0.8; }
        .markdown-content a { text-decoration: underline; }

        /* Dynamic Theme Classes */
        .theme-bg-app { background-color: var(--bg-app); color: var(--text-main); }
        .theme-bg-sidebar { background-color: var(--bg-sidebar); border-color: rgba(0,0,0,0.05); }
        .theme-text-main { color: var(--text-main); }
        .theme-primary { background-color: var(--primary); color: white; }
        .theme-primary:hover { background-color: var(--primary-hover); }
        .theme-text-primary { color: var(--primary); }
        .theme-border-primary { border-color: var(--primary); }
        
        .bubble-me { background-color: var(--msg-bubble-me); color: var(--msg-text-me); }
        .bubble-other { background-color: var(--bg-sidebar); color: var(--text-main); border: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body class="theme-bg-app font-sans antialiased h-screen overflow-hidden">
    <div id="app" class="h-full w-full"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDYI4Avd42wjJa3YOSKuGHhSCGgLFLZvik",
            authDomain: "presently-3babd.firebaseapp.com",
            projectId: "presently-3babd",
            storageBucket: "presently-3babd.firebasestorage.app",
            messagingSenderId: "646349632966",
            appId: "1:646349632966:web:70780e1952d3144842aec7",
            measurementId: "G-S78VX3DRBV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let messages = [];
        let typingUsers = {}; 
        let onlineUsers = [];
        let editingMessageId = null; 
        let lastTypingSent = 0;
        let showThemeModal = false;
        let currentThemeId = 0;
        let themes = [];

        // --- CONSTANTS ---
        const AVATAR_COLORS = [
            'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-green-500', 
            'bg-emerald-500', 'bg-teal-500', 'bg-cyan-500', 'bg-blue-500', 
            'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 
            'bg-pink-500', 'bg-rose-500'
        ];

        // --- THEME GENERATOR ---
        function generateThemes() {
            const list = [];
            list.push({ id: 0, name: 'Standard Blue', primary: '#2563eb', bgApp: '#f3f4f6', bgSidebar: '#ffffff', text: '#111827' });
            
            for (let i = 1; i < 100; i++) {
                const hue = Math.floor((i * 11) % 360); // Spread hues
                const isDark = i % 3 === 0; 
                
                const primary = `hsl(${hue}, 70%, 50%)`;
                const hover = `hsl(${hue}, 80%, 40%)`;
                
                list.push({
                    id: i,
                    name: `Theme ${i}`,
                    primary: primary,
                    primaryHover: hover,
                    bgApp: isDark ? `hsl(${hue}, 20%, 8%)` : `hsl(${hue}, 30%, 96%)`,
                    bgSidebar: isDark ? `hsl(${hue}, 20%, 12%)` : '#ffffff',
                    text: isDark ? '#f3f4f6' : '#111827'
                });
            }
            return list;
        }

        function applyTheme(themeId) {
            const theme = themes.find(t => t.id === Number(themeId)) || themes[0];
            const root = document.documentElement;
            
            root.style.setProperty('--primary', theme.primary);
            root.style.setProperty('--primary-hover', theme.primaryHover || theme.primary);
            root.style.setProperty('--bg-app', theme.bgApp);
            root.style.setProperty('--bg-sidebar', theme.bgSidebar);
            root.style.setProperty('--text-main', theme.text);
            
            // Adjust message bubble contrast
            root.style.setProperty('--msg-bubble-me', theme.primary);
            root.style.setProperty('--msg-text-me', '#ffffff');

            currentThemeId = theme.id;
            localStorage.setItem('chat_theme_id', theme.id);
        }

        // --- UTILS ---
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- APP INITIALIZATION ---
        function init() {
            themes = generateThemes();
            
            // Restore User
            const storedUser = localStorage.getItem('chat_user');
            if (storedUser) {
                try { currentUser = JSON.parse(storedUser); } 
                catch (e) { localStorage.removeItem('chat_user'); }
            }

            // Restore Theme
            const storedTheme = localStorage.getItem('chat_theme_id');
            applyTheme(storedTheme ? parseInt(storedTheme) : 0);

            render();
            
            if (currentUser) {
                setupFirestoreListeners();
                updatePresence();
                // Send heartbeat every 60 seconds
                setInterval(updatePresence, 60000);
            }

            document.addEventListener('click', handleGlobalClicks);
        }

        async function updatePresence() {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "users", currentUser.id), {
                    username: currentUser.username,
                    color: currentUser.color,
                    lastSeen: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Presence update failed", e);
            }
        }

        function setupFirestoreListeners() {
            // Messages Listener - UPDATED: Use 'desc' to get LATEST 100 messages, then reverse locally
            const q = query(collection(db, "messages"), orderBy("timestamp", "desc"), limit(100));
            onSnapshot(q, (snapshot) => {
                messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convert Firestore timestamp to millis
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toMillis() : Date.now()
                })).reverse(); // Reverse to chronological order
                renderChatMessages();
            });

            // Online Users Listener
            const usersQ = query(collection(db, "users"));
            onSnapshot(usersQ, (snapshot) => {
                const now = Date.now();
                // Consider online if seen in last 2 minutes (allow some buffer)
                const cutoff = now - (2 * 60 * 1000);
                
                const active = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.lastSeen && data.lastSeen.toMillis() > cutoff) {
                        active.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                // Sort online users by name
                onlineUsers = active.sort((a,b) => a.username.localeCompare(b.username));
                renderRightSidebar(); // Update RIGHT sidebar with list
            });

            // Typing Listener
            const typingQ = query(collection(db, "typing"));
            onSnapshot(typingQ, (snapshot) => {
                const now = Date.now();
                const newTyping = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId !== currentUser.id && data.timestamp && (now - data.timestamp.toMillis() < 3000)) {
                        newTyping[data.userId] = { username: data.username, timestamp: data.timestamp.toMillis() };
                    }
                });
                typingUsers = newTyping;
                updateTypingUI();
            });

            // Cleanup typing periodically
            setInterval(updateTypingUI, 1000);
        }

        // --- ACTIONS ---
        async function handleGlobalClicks(e) {
            const target = e.target;
            
            // Start Edit
            const editBtn = target.closest('.btn-start-edit');
            if (editBtn) {
                editingMessageId = editBtn.dataset.id;
                renderChatMessages();
                return;
            }

            // Delete
            const deleteBtn = target.closest('.btn-delete');
            if (deleteBtn) {
                if(confirm('Are you sure you want to delete this message?')) {
                    const id = deleteBtn.dataset.id;
                    try {
                        await deleteDoc(doc(db, "messages", id));
                        // Optimistic update handled by snapshot
                    } catch (err) {
                        console.error("Error deleting", err);
                        alert("Failed to delete message");
                    }
                }
                return;
            }

            // Cancel Edit
            const cancelBtn = target.closest('.btn-cancel-edit');
            if (cancelBtn) {
                editingMessageId = null;
                renderChatMessages();
                return;
            }

            // Save Edit
            const saveBtn = target.closest('.btn-save-edit');
            if (saveBtn) {
                const id = saveBtn.dataset.id;
                const input = document.querySelector(`.edit-input[data-id="${id}"]`);
                if (input && input.value.trim()) {
                    const newText = input.value.trim();
                    try {
                        await updateDoc(doc(db, "messages", id), {
                            text: newText,
                            edited: true
                        });
                        editingMessageId = null;
                        // Render will happen on snapshot update
                    } catch (err) {
                        console.error("Error updating", err);
                        alert("Failed to update message");
                    }
                }
                return;
            }

            // Theme Modal
            if (target.closest('#themeBtn')) {
                showThemeModal = true;
                renderThemeModal();
            }
            if (target.closest('#closeThemeBtn') || target.closest('#themeOverlay') === target) {
                showThemeModal = false;
                renderThemeModal();
            }
            
            // Select Theme
            const themeOption = target.closest('.theme-option');
            if (themeOption) {
                applyTheme(themeOption.dataset.id);
                renderThemeModal();
            }
        }

        // --- RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            if (currentUser) {
                renderChatRoom(app);
                renderThemeModal(); 
            } else {
                renderLogin(app);
            }
            if(window.lucide) window.lucide.createIcons();
        }

        function renderLogin(container) {
            container.innerHTML = `
                <div class="flex h-full min-h-screen w-full flex-col items-center justify-center bg-gradient-to-br from-gray-50 to-gray-200 p-4">
                    <div class="w-full max-w-md rounded-2xl bg-white p-8 shadow-xl">
                        <div class="mb-8 flex flex-col items-center text-center">
                            <div class="mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                <i data-lucide="message-circle" class="w-8 h-8"></i>
                            </div>
                            <h1 class="mb-2 text-3xl font-bold text-gray-900">SimpleConnect</h1>
                            <p class="text-gray-500">Live, Real-time, Markdown supported.</p>
                        </div>
                        <form id="loginForm" class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Display Name</label>
                                <input id="username" type="text" class="block w-full rounded-lg border border-gray-200 p-3 text-gray-900 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="e.g. Alex" autocomplete="off" autofocus>
                                <p id="loginError" class="text-sm text-red-500 hidden"></p>
                            </div>
                            <button type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-3 font-semibold text-white hover:bg-blue-700 transition-colors">
                                Join Chat
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const usernameInput = document.getElementById('username');
                const username = usernameInput.value.trim();

                if (!username || username.length < 2) {
                    const err = document.getElementById('loginError');
                    err.textContent = 'Name too short';
                    err.classList.remove('hidden');
                    return;
                }

                const user = {
                    id: crypto.randomUUID(),
                    username,
                    color: AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)]
                };
                
                currentUser = user;
                localStorage.setItem('chat_user', JSON.stringify(user));
                init(); // Re-run init to setup listeners
            });
        }

        function renderChatRoom(container) {
            container.innerHTML = `
                <div class="flex h-screen w-full flex-col theme-bg-app md:flex-row">
                    <!-- LEFT Sidebar (Nav) -->
                    <div id="sidebar" class="theme-bg-sidebar fixed inset-y-0 left-0 z-30 w-64 transform shadow-xl transition-transform duration-300 ease-in-out md:static md:translate-x-0 -translate-x-full border-r flex flex-col shrink-0">
                        <div class="border-b theme-border-primary p-6">
                            <h2 class="text-2xl font-bold theme-text-primary">SimpleConnect</h2>
                            <p class="text-sm opacity-60">Global Room</p>
                        </div>
                        <div id="sidebarContent" class="flex-1 overflow-y-auto p-4 space-y-6">
                            <!-- Injected by renderSidebar -->
                        </div>
                        <div class="p-4 border-t theme-border-primary">
                            <button id="logoutBtn" class="flex w-full items-center justify-center rounded-lg border border-red-200 bg-red-50/10 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50/20 transition-colors">
                                <i data-lucide="log-out" class="mr-2 w-4 h-4"></i> Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile Overlay -->
                    <div id="overlay" class="fixed inset-0 z-20 bg-black bg-opacity-50 md:hidden hidden"></div>

                    <!-- Main Chat (Center) -->
                    <div class="flex flex-1 flex-col overflow-hidden relative h-full">
                        <!-- Mobile Header -->
                        <div class="flex items-center justify-between border-b theme-bg-sidebar p-4 shadow-sm md:hidden shrink-0">
                            <h1 class="text-lg font-bold theme-text-primary">SimpleConnect</h1>
                            <button id="menuBtn" class="p-2 opacity-70 hover:opacity-100">
                                <i data-lucide="menu" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <!-- Messages -->
                        <div id="messagesList" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4"></div>
                        
                        <!-- Typing -->
                        <div id="typingIndicator" class="px-6 py-2 min-h-[2rem] text-xs opacity-60 italic flex items-center shrink-0"></div>

                        <!-- Input -->
                        <div class="theme-bg-sidebar p-4 border-t theme-border-primary shrink-0">
                            <form id="messageForm" class="mx-auto max-w-4xl relative">
                                <input id="messageInput" type="text" 
                                    placeholder="Message... (**bold**, *italic*, \`code\`)" 
                                    class="w-full rounded-full border border-gray-300 bg-gray-50/50 px-6 py-3 pr-12 theme-text-main focus:outline-none focus:ring-2 focus:ring-opacity-50 theme-border-primary" 
                                    autocomplete="off" 
                                    style="--tw-ring-color: var(--primary);">
                                <button type="submit" id="sendBtn" class="absolute right-2 top-1.5 rounded-full theme-primary p-2 transition-transform hover:scale-105 disabled:opacity-50 disabled:scale-100">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- RIGHT Sidebar (Online Users) - Hidden on mobile, visible on lg screens -->
                    <div id="rightSidebar" class="hidden lg:flex w-72 flex-col border-l theme-bg-sidebar theme-border-primary shrink-0">
                         <div class="p-6 border-b theme-border-primary">
                            <h3 class="text-sm font-bold uppercase tracking-wider opacity-70">Online Users</h3>
                         </div>
                         <div id="onlineUsersList" class="flex-1 overflow-y-auto p-2">
                             <!-- Injected by renderRightSidebar -->
                         </div>
                    </div>
                    
                    <div id="themeModalContainer"></div>
                </div>
            `;

            // Render Sidebars
            renderSidebar();
            renderRightSidebar();

            // Mobile Menu
            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('translate-x-0');
                overlay.classList.toggle('hidden');
            };
            if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);
            if (overlay) overlay.addEventListener('click', toggleSidebar);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('chat_user');
                location.reload();
            });

            // Message Sending
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');

            messageInput.addEventListener('input', (e) => {
                if (e.target.value.trim()) {
                    const now = Date.now();
                    if (now - lastTypingSent > 2500) {
                        setDoc(doc(db, "typing", currentUser.id), {
                            userId: currentUser.id,
                            username: currentUser.username,
                            timestamp: serverTimestamp()
                        });
                        lastTypingSent = now;
                    }
                }
            });

            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (!text) return;

                messageInput.value = '';
                
                try {
                    await addDoc(collection(db, "messages"), {
                        text: text,
                        senderId: currentUser.id,
                        senderName: currentUser.username,
                        senderColor: currentUser.color,
                        timestamp: serverTimestamp(),
                        edited: false
                    });
                } catch (err) {
                    console.error("Error sending", err);
                    alert("Failed to send message");
                }
            });
            
            renderChatMessages();
        }

        function renderSidebar() {
            // Renders Left Sidebar (Profile/Settings)
            const container = document.getElementById('sidebarContent');
            if (!container) return;
            
            const safeUsername = escapeHtml(currentUser.username);

            container.innerHTML = `
                <div>
                    <h3 class="mb-3 text-xs font-semibold uppercase tracking-wider opacity-50">My Profile</h3>
                    <div class="flex items-center space-x-3 rounded-xl bg-gray-100/10 p-2 border border-gray-200/20">
                        <div class="flex h-10 w-10 items-center justify-center rounded-full text-white font-bold shadow-sm ${currentUser.color}">
                            ${safeUsername.substring(0, 2).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-semibold text-sm">${safeUsername}</p>
                            <div class="flex items-center text-xs text-green-500">
                                <span class="mr-1.5 h-1.5 w-1.5 rounded-full bg-green-500"></span> Online
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="mb-3 text-xs font-semibold uppercase tracking-wider opacity-50">Settings</h3>
                    <button id="themeBtn" class="w-full flex items-center space-x-3 rounded-xl p-3 hover:bg-gray-100/10 transition-colors text-left border border-transparent hover:border-gray-200/20">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full theme-primary">
                            <i data-lucide="palette" class="w-4 h-4 text-white"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm">Themes</p>
                            <p class="text-xs opacity-60">Customization</p>
                        </div>
                    </button>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function renderRightSidebar() {
            // Renders Right Sidebar (Online Users)
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<div class="p-4 text-center opacity-50 text-sm italic">Looking for users...</div>';
                return;
            }

            container.innerHTML = onlineUsers.map(u => `
                <div class="flex items-center p-3 mb-1 hover:bg-black/5 rounded-xl transition-colors cursor-default group">
                   <div class="relative shrink-0">
                      <div class="flex h-10 w-10 items-center justify-center rounded-full text-white font-bold shadow-sm ${u.color || 'bg-gray-500'}">
                        ${escapeHtml(u.username).substring(0, 2).toUpperCase()}
                      </div>
                      <div class="absolute bottom-0 right-0 h-3 w-3 rounded-full bg-green-500 border-2 border-white ring-1 ring-gray-100"></div>
                   </div>
                   <div class="ml-3 min-w-0 flex-1">
                      <div class="flex items-center justify-between">
                          <p class="text-sm font-semibold truncate ${u.id === currentUser.id ? 'theme-text-primary' : 'theme-text-main'}">
                              ${escapeHtml(u.username)} ${u.id === currentUser.id ? '(You)' : ''}
                          </p>
                      </div>
                      <div class="flex items-center mt-0.5">
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200 uppercase tracking-wide">
                            <i data-lucide="crown" class="w-3 h-3 mr-1 fill-yellow-500 text-yellow-600"></i> VIP
                        </span>
                      </div>
                   </div>
                </div>
            `).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        function renderThemeModal() {
            const container = document.getElementById('themeModalContainer');
            if (!container) return;

            if (!showThemeModal) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div id="themeOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm">
                    <div class="w-full max-w-4xl h-[80vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Select Theme</h2>
                                <p class="text-gray-500 text-sm">100 styles available</p>
                            </div>
                            <button id="closeThemeBtn" class="p-2 hover:bg-gray-200 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 bg-white">
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                ${themes.map(t => `
                                    <button class="theme-option group relative flex flex-col items-center rounded-xl border-2 p-2 transition-all hover:scale-105 ${currentThemeId === t.id ? 'border-blue-600 ring-2 ring-blue-100' : 'border-gray-100 hover:border-gray-300'} shadow-sm bg-white" 
                                            data-id="${t.id}">
                                        <div class="w-full h-12 rounded mb-2 shadow-inner relative overflow-hidden" style="background-color: ${t.bgApp}">
                                            <div class="absolute inset-x-0 top-0 h-3 w-full opacity-80" style="background-color: ${t.primary}"></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-gray-600 group-hover:text-gray-900">${t.name}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
        }

        function renderChatMessages() {
            const list = document.getElementById('messagesList');
            if (!list) return;
            
            if (messages.length === 0) {
                list.innerHTML = `
                    <div class="flex h-full flex-col items-center justify-center text-center opacity-40">
                        <div class="mb-4 rounded-full bg-gray-200 p-6">
                            <i data-lucide="message-square-dashed" class="w-12 h-12"></i>
                        </div>
                        <h3 class="text-lg font-medium">No messages yet</h3>
                        <p class="max-w-xs text-sm">Start the conversation!</p>
                    </div>
                `;
            } else {
                list.innerHTML = messages.map(msg => {
                    const isMe = msg.senderId === currentUser.id;
                    const date = new Date(msg.timestamp);
                    const time = isNaN(date.getTime()) ? '...' : date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const isEditing = editingMessageId === msg.id;
                    const safeName = escapeHtml(msg.senderName);
                    
                    // Markdown Parsing
                    let cleanHtml = '';
                    if (window.marked && window.DOMPurify) {
                         try {
                             cleanHtml = window.DOMPurify.sanitize(window.marked.parse(msg.text));
                         } catch (e) {
                             cleanHtml = escapeHtml(msg.text);
                         }
                    } else {
                         cleanHtml = escapeHtml(msg.text);
                    }

                    if (isEditing) {
                        return `
                        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-4">
                            <div class="flex max-w-[95%] md:max-w-[80%] ${isMe ? 'flex-row-reverse' : 'flex-row'} items-start">
                                <div class="flex-1 min-w-0 bg-white rounded-lg border border-blue-200 p-3 shadow-lg z-10">
                                    <textarea 
                                        class="edit-input w-full p-2 mb-2 text-sm border border-gray-200 rounded focus:border-blue-500 focus:outline-none text-gray-800 bg-gray-50 resize-none" 
                                        rows="2"
                                        data-id="${msg.id}"
                                        autofocus
                                    >${escapeHtml(msg.text)}</textarea>
                                    <div class="flex justify-end space-x-2">
                                        <button class="btn-cancel-edit text-xs px-3 py-1.5 text-gray-500 hover:bg-gray-100 rounded">Cancel</button>
                                        <button class="btn-save-edit text-xs px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700" data-id="${msg.id}">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }

                    return `
                        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} group message-group">
                            <div class="flex max-w-[85%] md:max-w-[70%] ${isMe ? 'flex-row-reverse' : 'flex-row'} relative items-end">
                                <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-xs font-bold text-white shadow-sm ${msg.senderColor || 'bg-gray-500'} ${isMe ? 'ml-2' : 'mr-2'} mb-1">
                                    ${safeName.substring(0, 2).toUpperCase()}
                                </div>
                                
                                ${isMe ? `
                                    <div class="msg-actions absolute top-1/2 -translate-y-1/2 flex space-x-1 z-10 ${isMe ? '-left-20 pr-2' : '-right-20 pl-2'}">
                                        <button class="btn-start-edit p-1.5 text-gray-500 hover:text-blue-600 rounded-full bg-white shadow-sm border border-gray-200 hover:border-blue-300 transition-all transform hover:scale-110" data-id="${msg.id}" title="Edit">
                                            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button class="btn-delete p-1.5 text-gray-500 hover:text-red-600 rounded-full bg-white shadow-sm border border-gray-200 hover:border-red-300 transition-all transform hover:scale-110" data-id="${msg.id}" title="Delete">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                ` : ''}

                                <div class="relative rounded-2xl px-4 py-2 shadow-sm ${isMe ? 'rounded-tr-none bubble-me bg-me' : 'rounded-tl-none bubble-other'} min-w-[60px]">
                                    ${!isMe ? `<p class="mb-1 text-[10px] font-bold opacity-60 uppercase tracking-wide">${safeName}</p>` : ''}
                                    
                                    <div class="markdown-content text-sm md:text-base leading-relaxed break-words">
                                        ${cleanHtml}
                                    </div>
                                    
                                    <div class="flex items-center justify-end mt-1 space-x-1 opacity-60 border-t ${isMe ? 'border-white/20' : 'border-black/5'} pt-1">
                                        ${msg.edited ? '<span class="text-[9px] italic" title="Edited">(edited)</span>' : ''}
                                        <span class="text-[10px]">${time}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            if(window.lucide) window.lucide.createIcons();
            
            // Auto scroll if not editing
            if (!editingMessageId && list.scrollTop + list.clientHeight >= list.scrollHeight - 200) {
                 setTimeout(() => list.scrollTop = list.scrollHeight, 50);
            } else if (messages.length > 0 && list.scrollTop === 0) {
                 // Initial load scroll
                 setTimeout(() => list.scrollTop = list.scrollHeight, 100);
            }
        }

        function updateTypingUI() {
            const indicator = document.getElementById('typingIndicator');
            if (!indicator) return;
            
            const now = Date.now();
            // Cleanup in memory
            const active = Object.values(typingUsers).filter(u => now - u.timestamp < 3000).map(u => escapeHtml(u.username));
            
            if (active.length > 0) {
                const text = active.length === 1 ? `${active[0]} is typing` : 
                             active.length === 2 ? `${active[0]} and ${active[1]} are typing` : 
                             `${active.length} people are typing`;
                indicator.innerHTML = `
                    <span class="mr-1">${text}</span>
                    <span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span>
                    <span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span>
                    <span class="typing-dot inline-block w-1 h-1 bg-current rounded-full mx-[1px]"></span>
                `;
            } else {
                indicator.innerHTML = '';
            }
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
